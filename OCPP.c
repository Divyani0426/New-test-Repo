#include "OCPP.h"||#include "timers.h"||#include "uart.h"||#include <string.h>||#include <stdlib.h>||||SemaphoreHandle_t OCPP_Resp_semaphore;||SemaphoreHandle_t OCPP_mutex=NULL;||TimerHandle_t Heartbeat_Timer_Handle, MeterValuesPeriodic_Handle, MeterValuesClock_Handle, Boot_Timer_Handle;||char buffer[RECEIVE_BUFFER_SIZE];||char TransmitBuffer[TRANSMIT_BUFFER_SIZE];||char TagId[16];||uint8_t OfflineTransactionId=0;||uint8_t Mode;|||xQueueHandle SocketQueue[NO_OF_CONNECTOR];||xQueueHandle MeterQueue[NO_OF_CONNECTOR];||xQueueHandle NotificationQueue;|||SocketDetails_t Socket;||MeterDetails_t Meter;|||/**********************************************************************/||//                              Flags||/**********************************************************************/||char HeartbeatFlag=0;||char MeterValuesClockFlag=0;||char MeterValuesPeriodicFlag=0;||char BootFlag=0;||/**********************************************************************/||/**********************************************************************/|||||/*******************************************************************************************************/||         //             Read function ( Reads the data from the selected COMM.)||/*******************************************************************************************************/||uint8_t Read_Data()||{||  int index=0;||        if(UDataAvailable(NodeMCU_UART))||        {||          vTaskDelay(pdMS_TO_TICKS(100));               // Wait to recieve all the bytes||          while(UDataAvailable(NodeMCU_UART)>0)||          buffer[index++]=UReadData(NodeMCU_UART);||          buffer[index]='\0';||          return 1;||        }||        else return 0;||}|||/*******************************************************************************************************/||/*******************************************************************************************************/||||||||/*******************************************************************************************************/||         //             Write funciton ( Write the data to the selected COMM.)||/*******************************************************************************************************/||uint8_t Send_to_server(char *data)||{||       xSemaphoreTake( OCPP_Resp_semaphore, 0);         // Take any pending semaphore if any||        UFlushQ(NodeMCU_UART);||	UWriteString(NodeMCU_UART, data );||        if(xSemaphoreTake( OCPP_Resp_semaphore,pdMS_TO_TICKS(SERVER_RESPONSE_TIMEOUT))==pdTRUE)||          return 1;||        return 0;||}|||/*******************************************************************************************************/||/*******************************************************************************************************/||||||/*******************************************************************************************************/||//                                       TIMERS||/*******************************************************************************************************/|||void MeterValuesClock(TimerHandle_t xtimer)||{ MeterValuesClockFlag=1;}|||void MeterValuesPeriodic(TimerHandle_t xtimer)||{ MeterValuesPeriodicFlag=1;}|||void Heartbeat_Timer(TimerHandle_t xtimer)||{HeartbeatFlag=1;}|||void Boot_Timer(TimerHandle_t xtimer)||{BootFlag=1;}||/*******************************************************************************************************/||/*******************************************************************************************************/||||||/*******************************************************************************************************/||         //                          OCPP MSG Handler Task||/*******************************************************************************************************/||void OCPP_Msg_Handler(void * pvParameter)||{|| (void)pvParameter; ||  char MsgType[3]; ||  signed int var=0;||  jsmn_parser p;    ||  jsmntok_t t[25];||  traceLog("OCPP: Msg_Handlertask started");||   // while(        (wifi_status==WIFI_DISCONNECTED)||(server_status==DISCONNECTED_FROM_SERVER)      ){}|||  while(1)||  {||   var=0;||   if(Read_Data())||   {     ||        jsmn_init(&p);||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||        if (var < 0) ||        {traceLog("Parse Err:"); }||        else            // Parsing successful||        {||          get_val(t[1].end - t[1].start,  buffer + t[1].start, MsgType);||          if(strcmp(MsgType,"3")==0)            // Msg is response,<--- send the semaphore||          xSemaphoreGive(OCPP_Resp_semaphore);||          if(strcmp(MsgType,"2")==0)            // Msg is server initiated,<--- send Notfn to OCPP task||          xTaskNotify(OCPP_task_handle,(uint32_t)SERVER_INITIATED_MSG,eSetValueWithOverwrite);||          vTaskDelay(pdMS_TO_TICKS(100));       // <-If two msgs are received with minimum delay. Putted Delay to avoid msg overriding.||        }||   }||  }||}||/*******************************************************************************************************/||/*******************************************************************************************************/|||                                ||                                ||       ||/******************************************************************************************************************/||//                                      OCPP MAIN TASK||/******************************************************************************************************************/                          ||void OCPP_task(void * pvParameter)||{||  for(uint8_t o=0; o<NO_OF_CONNECTOR; o++)||  {||    SocketQueue[o]=xQueueCreate(1,sizeof(SocketDetails_t));||    MeterQueue[o]=xQueueCreate(1,sizeof(MeterDetails_t));||  }||  NotificationQueue=xQueueCreate(NOTIFICATION_Q_SIZE, sizeof(uint32_t));||  ||/******************************************************************************************************************/||/*                    Task functions          Task Name          Stack      Param    Priority          Handle     */||/******************************************************************************************************************/||/**/ xTaskCreate(     FailHandler_task    ,   "failureHndl"    ,   100   ,   NULL  ,    1       ,       NULL        );   ||/**/ xTaskCreate(     OCPP_Msg_Handler    ,   "ocpp_Msg_Hndl"  ,   300   ,   NULL  ,    1       ,  &OCPP_MSG_Handle ); ||/*******************************************************************************************************************/|||  char MsgType[25]; char MsgId[50]; uint8_t connectorId=0; ||  uint16_t AvailabilityFlag=0;||  signed int var=0; char charVariable; uint32_t GetConfigurationFlag[2]; void *vPointer=NULL;||  jsmn_parser p;    ||  jsmntok_t t[25];||  InitOCPP();||  USARTInit(NodeMCU_UART,NodeMCU_BAUDRATE);||  traceLog("OCPP: task started");||  static unsigned int intVariable; uint32_t notfn_value=0;||  intVariable=0;||  uint8_t TaskRestartFlag=0;||  RTC_TimeTypeDef RTC_TimeStruct;||  xEventGroupClearBits(EventHandle,CONNECTIVITY_BIT);|||  ||while(1)||{||  Mode=OFFLINE; TaskRestartFlag=0;||  while(        (wifi_status==WIFI_DISCONNECTED)||(server_status==DISCONNECTED_FROM_SERVER)      )||  {||    vTaskDelay(pdMS_TO_TICKS(1000));||    intVariable++; ||    if(intVariable==40) break;||  }||  if(intVariable<40)||  {xEventGroupSetBits(EventHandle,CONNECTIVITY_BIT);||   intVariable=0;||   Mode=ONLINE;}|||/********************************************************************************************************/||//                                      Boot Process||/********************************************************************************************************/  ||  if(Mode==ONLINE)||  {  ||        if(send_BootNotification(&boot_resp)==0) {traceLog("E10");}||        //Callibrate RTC with current time here;||        OCPP_Set_Time(boot_resp.current_time);||        if(boot_resp.Boot_Status==Boot_Accepted)      ||        {||          if(boot_resp.interval==0) boot_resp.interval=500;   // If interval is 0, then chargepoint can choose heartbeat interval on its own||          ||          Heartbeat_Timer_Handle=xTimerCreate("hb_tmr",pdMS_TO_TICKS(boot_resp.interval*1000),pdTRUE,0,Heartbeat_Timer);||          if(Heartbeat_Timer_Handle==NULL){traceLog("E11");}||          else {if(xTimerStart(Heartbeat_Timer_Handle, pdMS_TO_TICKS(500))==pdFAIL) traceLog("E12");}||          HeartbeatInterval=boot_resp.interval;||          MeterValuesClock_Handle=xTimerCreate("MVClk",pdMS_TO_TICKS(MeterValueSampleInterval*1000),pdTRUE,0,MeterValuesClock);||          if(MeterValuesClock_Handle==NULL) {traceLog("E15");}||          else{ if(xTimerStart(MeterValuesClock_Handle, pdMS_TO_TICKS(1000))==pdFAIL){traceLog("E16");}}||           ||           MeterValuesPeriodic_Handle=xTimerCreate("MVPeriodic",pdMS_TO_TICKS(35000),pdTRUE,0,MeterValuesPeriodic);||          if(MeterValuesPeriodic_Handle==NULL) traceLog("E6");||  ||          strcpy(notfn_param.errorCode,"NoError");||          for(char n=0; n<=NO_OF_CONNECTOR; n++)   ||          send_StatusNotification(n,&notfn_param);||                   ||          send_MeterValues(1,"Sample.Clock");           ||        }||        else if(boot_resp.Boot_Status==Boot_Rejected)||        {||          if(boot_resp.interval==0) boot_resp.interval=60;||          Boot_Timer_Handle=xTimerCreate("boot_timer",pdMS_TO_TICKS(boot_resp.interval*1000),pdTRUE,0,Boot_Timer);||          if(Boot_Timer_Handle==NULL){traceLog("E17");}||          else {if(xTimerStart(Boot_Timer_Handle, pdMS_TO_TICKS(500))==pdFAIL) traceLog("E18");}||        }||         else if(boot_resp.Boot_Status==Boot_Pending)||         {||           if(boot_resp.interval==0) boot_resp.interval=60;||           Boot_Timer_Handle=xTimerCreate("boot_timer",pdMS_TO_TICKS(boot_resp.interval*1000),pdTRUE,0,Boot_Timer);||           if(Boot_Timer_Handle==NULL){traceLog("E19");}||           else {if(xTimerStart(Boot_Timer_Handle, pdMS_TO_TICKS(500))==pdFAIL) traceLog("E20");}||         }||  }||/********************************************************************************************************/||/********************************************************************************************************/  ||  ||     ||      ||while(TaskRestartFlag==0)||{||      var=0; charVariable=0; intVariable=0;  GetConfigurationFlag[0]=0;  GetConfigurationFlag[1]=0;||      notfn_value=0;||  ||  if(        (wifi_status==WIFI_DISCONNECTED)||(server_status==DISCONNECTED_FROM_SERVER)      )||  {  xEventGroupClearBits(EventHandle,CONNECTIVITY_BIT);||      Mode=OFFLINE;  }  ||  else ||  { xEventGroupSetBits(EventHandle,CONNECTIVITY_BIT);||        if(Mode==OFFLINE)||          TaskRestartFlag=1;||      Mode=ONLINE;  ||  }||  ||  ||if(AvailabilityFlag!=0)||{||  intVariable=AvailabilityFlag&0x00FF;||  charVariable=((AvailabilityFlag&0xFF00)>>8);||  var=NO_TRANSACTION;||  ||  for(char j=0; j<NO_OF_CONNECTOR; j++)||    if(Connector[j].TransactionDetail!=NULL)||      var=SOME_TRANSACTION;|||  if(var==NO_TRANSACTION)||{||  if(intVariable==0)||  {||    for(char i=0; i<NO_OF_CONNECTOR; i++)||      Connector[i].ConnectorStatus=Connector_Unavailable;||      ChargePoint.ChargePointStatus=Connector_Unavailable;||      send_StatusNotification(intVariable,&notfn_param);||      AvailabilityFlag=0;||  }||  else if(Connector[intVariable-1].TransactionDetail==NULL)||  {||    Connector[intVariable-1].ConnectorStatus=Connector_Unavailable;||    send_StatusNotification(intVariable,&notfn_param);||    AvailabilityFlag=0;||  }||}||}||  ||| for(uint8_t t=0;t<NO_OF_CONNECTOR; t++)||{||  xQueuePeek(SocketQueue[t],&Socket,0);||  xQueuePeek(MeterQueue[t],&Meter,0);||    if(Socket.ChargingStatus==CHARGING_HO_RAHI_HAI)||    {||       Socket.EnergyConsumed= Meter.MeterData.R_PhaseActiveEnergy-Socket.OnStartEnergy;||       RTC_GetTime( RTC_Format_BIN, &RTC_TimeStruct);||       Socket.ChargingTime=(RTC_TimeStruct.RTC_Hours*60+RTC_TimeStruct.RTC_Minutes)-Socket.StartTime;      ||    }||    xQueueOverwrite(SocketQueue[t],&Socket);||}||    ||if( xQueueReceive(NotificationQueue,&notfn_value,0)==pdTRUE)||{||  connectorId=notfn_value&0x000000FF;             // Extract connector ID||  charVariable=((notfn_value&0x00FF0000)>>16);            // Extrace StatusNotification Type (if recieved)     ||  notfn_value&=0x0000FF00;              // Notification Value||   if(notfn_value==CLEAR)||    Clear(connectorId);||   if(notfn_value==CHARGING_COMPLETED)||   {||     StopCharging(connectorId,"Local","");||     xQueuePeek(SocketQueue[connectorId-1],&Socket,0);||     strcpy(Socket.PreviousError,"COMPLETED");||     xQueueOverwrite(SocketQueue[connectorId-1],&Socket);||     ||   }||   if(notfn_value==STATUS_NOTIFICATION)||       {||         if(charVariable==(ConnectorLockFailure>>16))||           strcpy(notfn_param.errorCode,"ConnectorLockFailure");||         if(charVariable==(EVCommunicationError>>16))||           strcpy(notfn_param.errorCode,"EVCommunicationError");||         if(charVariable==(GroundFailure>>16))||           strcpy(notfn_param.errorCode,"GroundFailure");   ||         if(charVariable==(HighTemperature>>16))||           strcpy(notfn_param.errorCode,"HighTemperature");||         if(charVariable==(InternalError>>16))||           strcpy(notfn_param.errorCode,"InternalError");||         if(charVariable==(LocalListConflict>>16))||           strcpy(notfn_param.errorCode,"LocalListConflict");||         if(charVariable==(NoError>>16))||         {||           Connector[connectorId-1].ConnectorStatus=Connector_Available;||           strcpy(notfn_param.errorCode,"NoError");||         }||         if(charVariable==(OtherError>>16))||           strcpy(notfn_param.errorCode,"OtherError");||         if(charVariable==(OverCurrentFailure>>16))||         {||           strcpy(notfn_param.errorCode,"OverCurrentFailure");||          if(Connector[connectorId-1].TransactionDetail!=NULL)||           StopCharging(connectorId,"EmergencyStop","");||         }||         if(charVariable==(PowerMeterFailure>>16))||         {||           Connector[connectorId-1].ConnectorStatus=Connector_Faulted;||           strcpy(notfn_param.errorCode,"PowerMeterFailure");||           if(Connector[connectorId-1].TransactionDetail!=NULL)||           StopCharging(connectorId,"EmergencyStop","");||         }||         if(charVariable==(PowerSwitchFailure>>16))||           strcpy(notfn_param.errorCode,"PowerSwitchFailure");||         if(charVariable==(ReaderFailure>>16))||           strcpy(notfn_param.errorCode,"ReaderFailure");||         if(charVariable==(ResetFailure>>16))||           strcpy(notfn_param.errorCode,"ResetFailure");||         if(charVariable==(UnderVoltage>>16))||         { ||           Connector[connectorId-1].ConnectorStatus=Connector_Faulted;||           strcpy(notfn_param.errorCode,"UnderVoltage");||           if(Connector[connectorId-1].TransactionDetail!=NULL)||           StopCharging(connectorId,"EmergencyStop","");||         }||         if(charVariable==(OverVoltage>>16))||         { ||           Connector[connectorId-1].ConnectorStatus=Connector_Faulted;||           strcpy(notfn_param.errorCode,"OverVoltage");||           if(Connector[connectorId-1].TransactionDetail!=NULL)||           StopCharging(connectorId,"EmergencyStop","");||         }||         if(charVariable==(WeakSignal>>16))||           strcpy(notfn_param.errorCode,"WeakSignal");||         send_StatusNotification(connectorId,&notfn_param);||       }||}||if(xTaskNotifyWait(0x00,0x00,&notfn_value,0)==pdTRUE)||{||        connectorId=notfn_value&0x000000FF;             // Extract connector ID||        notfn_value&=0x0000FF00;                        // Notification Value||        ||       if(  (notfn_value==SERVER_INITIATED_MSG)    &&      (boot_resp.Boot_Status!=Boot_Rejected)   )||       {     ||            charVariable=0;||            jsmn_init(&p);||            var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||            if (var < 0) ||            {traceLog("Parse Err:"); }||            else            // Parsing successful||            {||              get_val(t[3].end - t[3].start,  buffer + t[3].start, MsgType);    // Read the msg type||              get_val(t[2].end - t[2].start,  buffer + t[2].start, MsgId);    // Read the message id  ||                ||                ||                ||                ||    /****************************************************************************************************/||    //                              Cancel Reservation||    /****************************************************************************************************/            ||                if(strcmp(MsgType,"CancelReservation")==0)||                {||                  for (char i = 0; i < var; i++) ||                  if (jsoneq(buffer, &t[i], "reservationId") == 0)||                    {||                      intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                      break;        }||                  ||                  for(char i=0; i<NO_OF_CONNECTOR; i++)||                  {||                        if( (Connector[i].Reservation!=NULL)      &&      (Connector[i].Reservation->reservationId==intVariable)        )||                        {||                          vPortFree(Connector[i].Reservation);||                          Connector[i].Reservation=NULL;||                          Connector[i].ConnectorStatus=Connector_Available;||                          send_CommonResponse(MsgId,MsgType,"Accepted");    // send the status here..||                          break;||                        }    ||                       if(i==NO_OF_CONNECTOR-1) send_CommonResponse(MsgId,MsgType,"Rejected");||                  }||                  ||               }||    /****************************************************************************************************/||    /****************************************************************************************************/|||||                ||                ||                ||                ||                ||    /****************************************************************************************************/||    //                              Change Availability||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"ChangeAvailability")==0)||                {||                  for (char i = 0; i < var; i++) ||                    if (jsoneq(buffer, &t[i], "connectorId") == 0)||                    {intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start); break;}||                  for (char i = 0; i < var; i++)   ||                    if (jsoneq(buffer, &t[i], "type") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "Inoperative") == 0)      {charVariable='I';}||                      else if (jsoneq(buffer, &t[i+1], "Operative") == 0)   {charVariable='O';}||                      break;||                    }||                  ||                if(intVariable>NO_OF_CONNECTOR)||                  send_CommonResponse(MsgId,MsgType,"Rejected");||                else if(intVariable==0)||                {||                  for(char i=0; i<NO_OF_CONNECTOR; i++)||                  if(Connector[i].TransactionDetail!=NULL)||                  AvailabilityFlag=(charVariable<<8)|intVariable;||                  ||                  if(AvailabilityFlag==0)||                  {||                    for(char i=0;i<NO_OF_CONNECTOR;i++)||                    {||                      if(charVariable=='I')||                      {Connector[i].ConnectorStatus=Connector_Unavailable;}||                      else if(charVariable=='O')||                      {Connector[i].ConnectorStatus=Connector_Available;}||                    }||                    ChargePoint.ChargePointStatus=Connector_Unavailable;||                    send_CommonResponse(MsgId,MsgType,"Accepted");||                    send_StatusNotification(intVariable,&notfn_param);||                  }||                  else||                    send_CommonResponse(MsgId,MsgType,"Scheduled");||                  ||                }||                else||                {     if(charVariable=='O')||                      {||                        Connector[intVariable-1].ConnectorStatus=Connector_Available;||                        send_CommonResponse(MsgId,MsgType,"Accepted");                         ||                        send_StatusNotification(intVariable,&notfn_param);||                      }||                      else if(charVariable=='I')||                      {||                        //if(Connector[intVariable-1].Connector_status==Charging)||                        if(Connector[intVariable-1].TransactionDetail!=NULL)||                        { AvailabilityFlag=(charVariable<<8)|intVariable;||                          send_CommonResponse(MsgId,MsgType,"Scheduled");}   ||                        else||                        {||                          Connector[intVariable-1].ConnectorStatus=Connector_Unavailable;||                          send_CommonResponse(MsgId,MsgType,"Accepted");||                          send_StatusNotification(intVariable,&notfn_param);||                        }||                      }||                }     ||              }||    /****************************************************************************************************/||    /****************************************************************************************************/            |||                ||                ||                ||                ||                ||                |||    /*****************************************************************************************************************/||    //                                              Change Configuration||    /*****************************************************************************************************************/            ||                 else if(strcmp(MsgType,"ChangeConfiguration")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "key") == 0)||                    {  if (jsoneq(buffer, &t[i+1], "AllowOfflineTxForUnknownId") == 0)              {charVariable=1;}||                       else if (jsoneq(buffer, &t[i+1], "AuthorizationCacheEnabled") == 0)          {charVariable=2;}||                       else if (jsoneq(buffer, &t[i+1], "AuthorizeRemoteTxRequests") == 0)          {charVariable=3;}||                       else if (jsoneq(buffer, &t[i+1], "BlinkRepeat") == 0)                        {charVariable=4;}||                       else if (jsoneq(buffer, &t[i+1], "ClockAlignedDataInterval") == 0)           {charVariable=5;}||                       else if (jsoneq(buffer, &t[i+1], "ConnectionTimeOut") == 0)                  {charVariable=6;}||                       else if (jsoneq(buffer, &t[i+1], "HeartbeatInterval") == 0)                  {charVariable=7;}||                       else if (jsoneq(buffer, &t[i+1], "LightIntensity") == 0)                     {charVariable=8;}||                       else if (jsoneq(buffer, &t[i+1], "LocalAuthorizeOffline") == 0)              {charVariable=9;}||                       else if (jsoneq(buffer, &t[i+1], "LocalPreAuthorize") == 0)                  {charVariable=10;}||                       else if (jsoneq(buffer, &t[i+1], "MaxEnergyOnInvalidId") == 0)               {charVariable=11;}||                       else if (jsoneq(buffer, &t[i+1], "MeterValueSampleInterval") == 0)           {charVariable=12;}||                       else if (jsoneq(buffer, &t[i+1], "MinimumStatusDuration") == 0)              {charVariable=13;}||                       else if (jsoneq(buffer, &t[i+1], "ResetRetries") == 0)                       {charVariable=14;}||                       else if (jsoneq(buffer, &t[i+1], "StopTransactionOnEVSideDisconnect") == 0)  {charVariable=15;}||                       else if (jsoneq(buffer, &t[i+1], "StopTransactionOnInvalidId") == 0)         {charVariable=16;}||                       else if (jsoneq(buffer, &t[i+1], "TransactionMessageAttempts") == 0)         {charVariable=17;}||                       else if (jsoneq(buffer, &t[i+1], "TransactionMessageRetryInterval") == 0)    {charVariable=18;}||                       else if (jsoneq(buffer, &t[i+1], "UnlockConnectorOnEVSideDisconnect") == 0)  {charVariable=19;}||                       else if (jsoneq(buffer, &t[i+1], "WebSocketPingInterval") == 0)              {charVariable=20;}||                       else if (jsoneq(buffer, &t[i+1], "LocalAuthListEnabled") == 0)               {charVariable=21;}||                    }||                    if (jsoneq(buffer, &t[i], "value") == 0)||                   intVariable= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);// key value is fetched||                  }||                  if(charVariable==1){AllowOfflineTxForUnknownId=intVariable;}||                  else if(charVariable==2){AuthorizationCacheEnabled=intVariable;}||                  else if(charVariable==3){AuthorizeRemoteTxRequests=intVariable;}||                  else if(charVariable==4){BlinkRepeat=intVariable;}||                  else if(charVariable==5){ClockAlignedDataInterval=intVariable;}||                  else if(charVariable==6){ConnectionTimeOut=intVariable;}||                  else if(charVariable==7){HeartbeatInterval=intVariable;||                  xTimerChangePeriod( Heartbeat_Timer_Handle,pdMS_TO_TICKS(HeartbeatInterval*1000),pdMS_TO_TICKS(10000));}||                  else if(charVariable==8){LightIntensity=intVariable;}||                  else if(charVariable==9){LocalAuthorizeOffline=intVariable;}||                  else if(charVariable==10){LocalPreAuthorize=intVariable;}||                  else if(charVariable==11){MaxEnergyOnInvalidId=intVariable;}||                  else if(charVariable==12){MeterValueSampleInterval=intVariable;||                  xTimerChangePeriod( MeterValuesClock_Handle,pdMS_TO_TICKS(MeterValueSampleInterval*1000),||                                   pdMS_TO_TICKS(10000));}||                  else if(charVariable==13){MinimumStatusDuration=intVariable;}||                  else if(charVariable==14){ResetRetries=intVariable;}||                  else if(charVariable==15){StopTransactionOnEVSideDisconnect=intVariable;}||                  else if(charVariable==16){StopTransactionOnInvalidId=intVariable;}||                  else if(charVariable==17){TransactionMessageAttempts=intVariable;}||                  else if(charVariable==18){TransactionMessageRetryInterval=intVariable;}||                  else if(charVariable==19){UnlockConnectorOnEVSideDisconnect=intVariable;}||                  else if(charVariable==20){WebSocketPingInterval=intVariable;}||                  else if(charVariable==21){LocalAuthListEnabled=intVariable;}||               ||                  if(charVariable!=0)||                  send_CommonResponse(MsgId,MsgType,"Accepted");||                  else||                  send_CommonResponse(MsgId,MsgType,"Rejected");||                }||    /****************************************************************************************************/||    /****************************************************************************************************/            ||              ||                ||                ||                |||    /****************************************************************************************************/||    //                              ClearCacheRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"ClearCache")==0)||                {||                  ||                  //Take the action here||                  send_CommonResponse(MsgId,MsgType,"Accepted"); // <-- send the status here||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||||                ||                ||    /****************************************************************************************************/||    //                              ClearChargingProfileRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"ClearChargingProfile")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "id") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    if (jsoneq(buffer, &t[i], "connectorId") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    if (jsoneq(buffer, &t[i], "chargingProfilePurpose") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "ChargePointMaxProfile") == 0){traceLog("charmxprgl");/*Take action here*/}||                      else  if (jsoneq(buffer, &t[i+1], "TxDefaultProfile") == 0){traceLog("txdefltprfl");/*Take action here*/}||                      else  if (jsoneq(buffer, &t[i+1], "TxProfile") == 0){traceLog("txprfl");/*Take action here*/}||                    }||                    if (jsoneq(buffer, &t[i], "stackLevel") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                  }||                  //Take the action here||                  send_CommonResponse(MsgId,MsgType,"Accepted");//<-- Send the status here||                }||    /****************************************************************************************************/||    /****************************************************************************************************/                        ||                |||                ||                ||                ||                ||                ||    /****************************************************************************************************/||    //                             DataTransfer Request||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"DataTransfer")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    // Under construction||                  }||                  //Take the action here||                  //send_DataTransferResponse(MsgType,status);||                }||    /****************************************************************************************************/||    /****************************************************************************************************/            ||||                ||                ||                ||                |||    /****************************************************************************************************/||    //                               GetCompositeScheduleRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"GetCompositeSchedule")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "connectorId") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    if (jsoneq(buffer, &t[i], "duration") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                     if (jsoneq(buffer, &t[i], "chargingRateUnit") == 0)||                     {||                       if (jsoneq(buffer, &t[i+1], "A") == 0){/*Take the action here*/}||                       else if (jsoneq(buffer, &t[i+1], "W") == 0){/*Take the action here*/}||                     }||                  }||                  //Take the action here||                  //send_GetCompositeScheduleResponse(MsgType,status);||                }||    /****************************************************************************************************/||    /****************************************************************************************************/            ||||                ||                ||                ||                |||    /****************************************************************************************************/||    //                               GetConfigurationRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"GetConfiguration")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "AllowOfflineTxForUnknownId") == 0)           {GetConfigurationFlag[0]|=Flag_AllowOfflineTxForUnknownId;}||                    if (jsoneq(buffer, &t[i], "AuthorizationCacheEnabled") == 0)            {GetConfigurationFlag[0]|=Flag_AuthorizationCacheEnabled;}||                    if (jsoneq(buffer, &t[i], "AuthorizeRemoteTxRequests") == 0)            {GetConfigurationFlag[0]|=Flag_AuthorizeRemoteTxRequests;}||                    if (jsoneq(buffer, &t[i], "BlinkRepeat") == 0)                          {GetConfigurationFlag[0]|=Flag_BlinkRepeat;}||                    if (jsoneq(buffer, &t[i], "ClockAlignedDataInterval") == 0)             {GetConfigurationFlag[0]|=Flag_ClockAlignedDataInterval;}||                    if (jsoneq(buffer, &t[i], "ConnectionTimeOut") == 0)                    {GetConfigurationFlag[0]|=Flag_ConnectionTimeOut;}||                    if (jsoneq(buffer, &t[i], "ConnectorPhaseRotationMaxLength") == 0)      {GetConfigurationFlag[0]|=Flag_ConnectorPhaseRotationMaxLength;}||                    if (jsoneq(buffer, &t[i], "GetConfigurationMaxKeys") == 0)              {GetConfigurationFlag[0]|=Flag_GetConfigurationMaxKeys;}||                    if (jsoneq(buffer, &t[i], "HeartbeatInterval") == 0)                    {GetConfigurationFlag[0]|=Flag_HeartbeatInterval;}||                    if (jsoneq(buffer, &t[i], "LightIntensity") == 0)                       {GetConfigurationFlag[0]|=Flag_LightIntensity;}||                    if (jsoneq(buffer, &t[i], "LocalAuthorizeOffline") == 0)                {GetConfigurationFlag[0]|=Flag_LocalAuthorizeOffline;}||                    if (jsoneq(buffer, &t[i], "LocalPreAuthorize") == 0)                    {GetConfigurationFlag[0]|=Flag_LocalPreAuthorize;}||                    if (jsoneq(buffer, &t[i], "MaxEnergyOnInvalidId") == 0)                 {GetConfigurationFlag[0]|=Flag_MaxEnergyOnInvalidId;}||                    if (jsoneq(buffer, &t[i], "MeterValuesAlignedDataMaxLength") == 0)      {GetConfigurationFlag[0]|=Flag_MeterValuesAlignedDataMaxLength;}||                    if (jsoneq(buffer, &t[i], "MeterValuesSampledDataMaxLength") == 0)      {GetConfigurationFlag[0]|=Flag_MeterValuesSampledDataMaxLength;}||                    if (jsoneq(buffer, &t[i], "MeterValueSampleInterval") == 0)             {GetConfigurationFlag[0]|=Flag_MeterValueSampleInterval;}||                    if (jsoneq(buffer, &t[i], "MinimumStatusDuration") == 0)                {GetConfigurationFlag[0]|=Flag_MinimumStatusDuration;}||                    if (jsoneq(buffer, &t[i], "NumberOfConnectors") == 0)                   {GetConfigurationFlag[0]|=Flag_NumberOfConnectors;}||                    if (jsoneq(buffer, &t[i], "ResetRetries") == 0)                         {GetConfigurationFlag[0]|=Flag_ResetRetries;}||                    if (jsoneq(buffer, &t[i], "StopTransactionOnEVSideDisconnect") == 0)    {GetConfigurationFlag[0]|=Flag_StopTransactionOnEVSideDisconnect;}||                    if (jsoneq(buffer, &t[i], "StopTransactionOnInvalidId") == 0)           {GetConfigurationFlag[0]|=Flag_StopTransactionOnInvalidId;}||                    if (jsoneq(buffer, &t[i], "StopTxnAlignedDataMaxLength") == 0)          {GetConfigurationFlag[0]|=Flag_StopTxnAlignedDataMaxLength;}||                    if (jsoneq(buffer, &t[i], "StopTxnSampledDataMaxLength") == 0)          {GetConfigurationFlag[1]|=Flag_StopTxnSampledDataMaxLength;}||                    if (jsoneq(buffer, &t[i], "SupportedFeatureProfilesMaxLength") == 0)    {GetConfigurationFlag[1]|=Flag_SupportedFeatureProfilesMaxLength;}||                    if (jsoneq(buffer, &t[i], "TransactionMessageAttempts") == 0)           {GetConfigurationFlag[1]|=Flag_TransactionMessageAttempts;}||                    if (jsoneq(buffer, &t[i], "UnlockConnectorOnEVSideDisconnect") == 0)    {GetConfigurationFlag[1]|=Flag_UnlockConnectorOnEVSideDisconnect;}||                    if (jsoneq(buffer, &t[i], "TransactionMessageRetryInterval") == 0)      {GetConfigurationFlag[1]|=Flag_TransactionMessageRetryInterval;}||                    if (jsoneq(buffer, &t[i], "WebSocketPingInterval") == 0)                {GetConfigurationFlag[1]|=Flag_WebSocketPingInterval;}||                    if (jsoneq(buffer, &t[i], "LocalAuthListEnabled") == 0)                 {GetConfigurationFlag[1]|=Flag_LocalAuthListEnabled;}||                    if (jsoneq(buffer, &t[i], "LocalAuthListMaxLength") == 0)               {GetConfigurationFlag[1]|=Flag_LocalAuthListMaxLength;}||                    if (jsoneq(buffer, &t[i], "SendLocalListMaxLength") == 0)               {GetConfigurationFlag[1]|=Flag_SendLocalListMaxLength;}||                    if (jsoneq(buffer, &t[i], "ReserveConnectorZeroSupported") == 0)        {GetConfigurationFlag[1]|=Flag_ReserveConnectorZeroSupported;}||                    if (jsoneq(buffer, &t[i], "ChargeProfileMaxStackLevel") == 0)           {GetConfigurationFlag[1]|=Flag_ChargeProfileMaxStackLevel;}||                    if (jsoneq(buffer, &t[i], "ChargingScheduleMaxPeriods") == 0)           {GetConfigurationFlag[1]|=Flag_ChargingScheduleMaxPeriods;}||                    if (jsoneq(buffer, &t[i], "ConnectorSwitch3to1PhaseSupported") == 0)    {GetConfigurationFlag[1]|=Flag_ConnectorSwitch3to1PhaseSupported;}||                    if (jsoneq(buffer, &t[i], "MaxChargingProfilesInstalled") == 0)         {GetConfigurationFlag[1]|=Flag_MaxChargingProfilesInstalled;}||                  }||                  //Take the action here||                  send_GetConfigurationResponse(GetConfigurationFlag,MsgId);||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||                ||                ||                ||                ||                ||                ||    /****************************************************************************************************/||    //                               GetDiagnosticsRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"GetDiagnostics")==0)||                {||                  Diagnostics=(Diagnostics_t*)pvPortMalloc(sizeof(Diagnostics_t));||                  if(Diagnostics!=NULL)||                  {      ||                      for (char i = 0; i < var; i++) ||                      {||                        if (jsoneq(buffer, &t[i], "location") == 0)||                        get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, Diagnostics->location);||                        if (jsoneq(buffer, &t[i], "retries") == 0)||                        Diagnostics->retries=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                         if (jsoneq(buffer, &t[i], "retryInterval") == 0)||                        Diagnostics->retryInterval=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                        if (jsoneq(buffer, &t[i], "startTime") == 0)||                        get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, Diagnostics->startTime);||                        if (jsoneq(buffer, &t[i], "stopTime") == 0)||                        get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, Diagnostics->stopTime);||                      }||                      //Take the action here||                      send_CommonResponse(MsgId,MsgType,"filename");||                  }||                  else||                  {||                    //traceLog the error here||                  }||               }||    /****************************************************************************************************/||    /****************************************************************************************************/||               ||               ||               ||               ||               ||               ||               ||    /****************************************************************************************************/||    //                               GetLocalListVersionRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"GetLocalListVersion")==0)||                {||                  send_GetLocalListVersionResponse(MsgId,&listVersion);||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||                ||                ||               ||                ||                ||                |||    /****************************************************************************************************************/||    //                                   RemoteStartTransactionRequest||    /****************************************************************************************************************/            ||                else if(strcmp(MsgType,"RemoteStartTransaction")==0)||                { ||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "connectorId") == 0) ||                      intVariable= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    if (jsoneq(buffer, &t[i], "idTag") == 0) ||                    {||                      vPointer=pvPortMalloc(20*sizeof(char));||                      get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, vPointer);||                    }||                  }||                  if(intVariable==0 || intVariable >NO_OF_CONNECTOR || Connector[intVariable-1].TransactionDetail!=NULL      \||                     || Connector[intVariable-1].ConnectorStatus!=Connector_Available)||                      send_CommonResponse(MsgId,MsgType,"Rejected");  ||                  else||                  {||                    if(Connector[intVariable-1].Reservation!=NULL)           // If there is reservation||                    {||                      if(strcmp(Connector[intVariable-1].Reservation->idTag,vPointer)!=0)    // If TagId doesnt match reservation||                      send_CommonResponse(MsgId,MsgType,"Rejected");  ||                      else||                      {||                        send_CommonResponse(MsgId,MsgType,"Accepted");||                        Connector[intVariable-1].TransactionDetail=(TransactionDetail_t*)pvPortMalloc(sizeof(TransactionDetail_t));||                        strcpy(Connector[intVariable-1].TransactionDetail->idTag,vPointer);       ||                        StartCharging(intVariable);||                      }||                    }||                    else||                    {  ||                      if(AuthorizeRemoteTxRequests==1)||                      {||                        send_CommonResponse(MsgId,MsgType,"Accepted");||                        send_Authorize(vPointer, &authorize_resp);||                        if(authorize_resp.AuthorizeStatus==Authorize_Accepted)||                        {  ||                          Connector[intVariable-1].TransactionDetail=(TransactionDetail_t*)pvPortMalloc(sizeof(TransactionDetail_t));||                          strcpy(Connector[intVariable-1].TransactionDetail->idTag,vPointer);       ||                          StartCharging(intVariable);||                        } ||                        else||                          send_CommonResponse(MsgId,MsgType,"Rejected");||                      }||                      else if(AuthorizeRemoteTxRequests==0)  ||                      {||                        send_CommonResponse(MsgId,MsgType,"Accepted");||                        Connector[intVariable-1].TransactionDetail=(TransactionDetail_t*)pvPortMalloc(sizeof(TransactionDetail_t));||                        strcpy(Connector[intVariable-1].TransactionDetail->idTag,vPointer);||                        StartCharging(intVariable);||                      }||                    }||                  }||                  vPortFree(vPointer); vPointer=NULL;||                    /*||                    else if (jsoneq(buffer, &t[i], "chargingProfileId") == 0)||                    ChargingProfile.chargingProfileId= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "transactionId") == 0)||                    ChargingProfile.transactionId= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "stackLevel") == 0)||                    ChargingProfile.stackLevel= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "chargingProfilePurpose") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "ChargePointMaxProfile") == 0)    {ChargingProfile.chargingProfilePurpose=ChargePointMaxProfile;}||                      else if (jsoneq(buffer, &t[i+1], "TxDefaultProfile") == 0)    {ChargingProfile.chargingProfilePurpose=TxDefaultProfile;}||                      else if (jsoneq(buffer, &t[i+1], "TxProfile") == 0)           {ChargingProfile.chargingProfilePurpose=TxProfile;}||                    }||                    else if (jsoneq(buffer, &t[i], "chargingProfileKind") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "Absolute") == 0)         {ChargingProfile.chargingProfileKind=Absolute;}||                      else if (jsoneq(buffer, &t[i+1], "Recurring") == 0)   {ChargingProfile.chargingProfileKind=Recurring;}||                      else if (jsoneq(buffer, &t[i+1], "Relative") == 0)    {ChargingProfile.chargingProfileKind=Relative;}||                    }||                    else if (jsoneq(buffer, &t[i], "recurrencyKind") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "Daily") == 0)         {ChargingProfile.recurrencyKind=Daily;}||                      else if (jsoneq(buffer, &t[i+1], "Weekly") == 0)   {ChargingProfile.recurrencyKind=Weekly;}||                    }||                    else if (jsoneq(buffer, &t[i], "validFrom") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,ChargingProfile.validFrom);||                    else if (jsoneq(buffer, &t[i], "validTo") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,ChargingProfile.validTo);||                    else if (jsoneq(buffer, &t[i], "duration") == 0)||                    ChargingProfile.duration= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "startSchedule") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,ChargingProfile.startSchedule);||                    else if (jsoneq(buffer, &t[i], "chargingRateUnit") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,&ChargingProfile.chargingRateUnit);||                    else if (jsoneq(buffer, &t[i], "startPeriod") == 0)||                    ChargingProfile.chargingSchedulePeriod[1].startPeriod= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "limit") == 0)||                    ChargingProfile.chargingSchedulePeriod[1].limit= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "numberPhases") == 0)||                    ChargingProfile.chargingSchedulePeriod[1].numberPhases= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "minChargingRate") == 0)||                    ChargingProfile.minChargingRate= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                  }*/|||                }||    /****************************************************************************************************/||    /****************************************************************************************************/||||                ||                ||                ||                ||    ///****************************************************************************************************/||    ////                               RemoteStopTransactionRequest||    ///****************************************************************************************************/            ||                else if(strcmp(MsgType,"RemoteStopTransaction")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "transactionId") == 0)||                    intVariable= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                  }||                  for(char i=0; i<NO_OF_CONNECTOR; i++)||                  {  if(Connector[i].TransactionDetail!=NULL)||                      if(Connector[i].TransactionDetail->TransactionId==intVariable)||                      {||                        send_CommonResponse(MsgId,MsgType,"Accepted");||                        StopCharging(i+1,"Remote","");||                        break;||                      }||                     if(i==NO_OF_CONNECTOR-1)||                       send_CommonResponse(MsgId,MsgType,"Rejected");||                  }||                }||    ///****************************************************************************************************/||    ///****************************************************************************************************/|||                ||                ||                ||                ||                ||                ||                ||    /****************************************************************************************************/||    //                               ReserveNowRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"ReserveNow")==0)||                {||                  ||                  for (char i = 0; i < var; i++) ||                  if (jsoneq(buffer, &t[i], "connectorId") == 0)  ||                  {intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start); break;}         // get connector ID||                  if(intVariable>0)||                  {    if(      (intVariable<=NO_OF_CONNECTOR) &&     Connector[intVariable-1].ConnectorStatus!=Connector_Unavailable      )||                      {  ||                          if((Connector[intVariable-1].Reservation==NULL) &&  (Connector[intVariable-1].TransactionDetail==NULL))    // if No reservation availble||                          {||                            if(Connector[intVariable-1].ConnectorStatus!=Connector_Faulted) // && chargePoint==No_chargepoint_error||                            {||                                  Connector[intVariable-1].Reservation=(Reservation_t*)pvPortMalloc(sizeof(Reservation_t));||                                  if(Connector[intVariable-1].Reservation==NULL) ||                                  {||                                      /*Log the error here*/||                                      send_CommonResponse(MsgId,MsgType,"Faulted");||                                  }||                                  else{||                                    for (char j = 0; j < var; j++)||                                    {||                                      if (jsoneq(buffer, &t[j], "expiryDate") == 0)||                                      get_val(t[j+1].end - t[j+1].start,  buffer + t[j+1].start, Connector[intVariable-1].Reservation->expiryDate);||                                      if (jsoneq(buffer, &t[j], "idTag") == 0)||                                      get_val(t[j+1].end - t[j+1].start,  buffer + t[j+1].start, Connector[intVariable-1].Reservation->idTag);||                                      if (jsoneq(buffer, &t[j], "parentIdTag") == 0)||                                      get_val(t[j+1].end - t[j+1].start,  buffer + t[j+1].start, Connector[intVariable-1].Reservation->parentIdTag);||                                      if (jsoneq(buffer, &t[j], "reservationId") == 0)||                                      Connector[intVariable-1].Reservation->reservationId=StrToInteger(t[j+1].end - t[j+1].start,  buffer + t[j+1].start);||                                    }||                                    Connector[intVariable-1].ConnectorStatus=Connector_Reserved;||                                      send_CommonResponse(MsgId,MsgType,"Accepted");||                                      }||                            }||                            else send_CommonResponse(MsgId,MsgType,"Faulted");||                          }||                          else send_CommonResponse(MsgId,MsgType,"Occupied");||                       }||                      else send_CommonResponse(MsgId,MsgType,"Unavailable");||                  }||                  else // if connectorId==0||                  {||                    if(ReserveConnectorZeroSupported)||                    {/*Write for connectorId 0 support code*/}||                    else send_CommonResponse(MsgId,MsgType,"Rejected");||                  }||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||                ||                ||                ||                ||||    /****************************************************************************************************/||    //                               ResetRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"Reset")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "type") == 0)||                    {||                      if(jsoneq(buffer, &t[i+1], "Hard") == 0){charVariable='H';}||                      if(jsoneq(buffer, &t[i+1], "Soft") == 0){charVariable='S';}||                    }||                  }  ||                  send_CommonResponse(MsgId,MsgType,"Accepted");||                  if(charVariable=='H')     {/*Hard reset here*/}||                  else if(charVariable=='S'){NVIC_SystemReset();/*Soft reset here*/}||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||||||    /****************************************************************************************************/||    //                               SendLocalListRequest||    /****************************************************************************************************/            ||                else if(strcmp(MsgType,"SendLocalList")==0)||                {||                  LocalAuthorizationList_t LocalList;||                  strcpy(LocalList.expiryDate,"");||                  strcpy(LocalList.parentIdTag,"");||                  for (char i = 0; i < var; i++) ||                  {||                     if (jsoneq(buffer, &t[i], "idTag") == 0)||                     get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, LocalList.idTag);||                     if (jsoneq(buffer, &t[i], "expiryDate") == 0)||                     get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, LocalList.expiryDate);||                     if (jsoneq(buffer, &t[i], "parentIdTag") == 0)||                     get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, LocalList.parentIdTag);||                      if (jsoneq(buffer, &t[i], "status") == 0)||                      {||                        if (jsoneq(buffer, &t[i+1], "Accepted") == 0)       {LocalList.status=Authorize_Accepted;}||                        if (jsoneq(buffer, &t[i+1], "Blocked") == 0)        {LocalList.status=Authorize_Blocked;}||                        if (jsoneq(buffer, &t[i+1], "Expired") == 0)        {LocalList.status=Authorize_Expired;}||                        if (jsoneq(buffer, &t[i+1], "Invalid") == 0)        {LocalList.status=Authorize_Invalid;}||                        if (jsoneq(buffer, &t[i+1], "ConcurrentTx") == 0)   {LocalList.status=Authorize_ConcurrentTx;}||                      }||                  }||                  //Take the action here||                  AddLocalList(&LocalList);||                  send_CommonResponse(MsgId,MsgType,"Accepted");||                }||    /****************************************************************************************************/||    /****************************************************************************************************/||    ||    ||    ||    ||    ||    /****************************************************************************************************/||    //                               SetChargingProfileRequest||    /****************************************************************************************************/            ||                if(strcmp(MsgType,"SetChargingProfile")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "connectorId") == 0)||                    ChargingProfile.connectorId= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "chargingProfileId") == 0)||                    ChargingProfile.chargingProfileId= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "transactionId") == 0)||                    ChargingProfile.transactionId= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "stackLevel") == 0)||                    ChargingProfile.stackLevel= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "chargingProfilePurpose") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "ChargePointMaxProfile") == 0)    {ChargingProfile.chargingProfilePurpose=ChargePointMaxProfile;}||                      else if (jsoneq(buffer, &t[i+1], "TxDefaultProfile") == 0)    {ChargingProfile.chargingProfilePurpose=TxDefaultProfile;}||                      else if (jsoneq(buffer, &t[i+1], "TxProfile") == 0)           {ChargingProfile.chargingProfilePurpose=TxProfile;}||                    }||                    else if (jsoneq(buffer, &t[i], "chargingProfileKind") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "Absolute") == 0)         {ChargingProfile.chargingProfileKind=Absolute;}||                      else if (jsoneq(buffer, &t[i+1], "Recurring") == 0)   {ChargingProfile.chargingProfileKind=Recurring;}||                      else if (jsoneq(buffer, &t[i+1], "Relative") == 0)    {ChargingProfile.chargingProfileKind=Relative;}||                    }||                    else if (jsoneq(buffer, &t[i], "recurrencyKind") == 0)||                    {||                      if (jsoneq(buffer, &t[i+1], "Daily") == 0)         {ChargingProfile.recurrencyKind=Daily;}||                      else if (jsoneq(buffer, &t[i+1], "Weekly") == 0)   {ChargingProfile.recurrencyKind=Weekly;}||                    }||                    else if (jsoneq(buffer, &t[i], "validFrom") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,ChargingProfile.validFrom);||                    else if (jsoneq(buffer, &t[i], "validTo") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,ChargingProfile.validTo);||                    else if (jsoneq(buffer, &t[i], "duration") == 0)||                    ChargingProfile.duration= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "startSchedule") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,ChargingProfile.startSchedule);||                    else if (jsoneq(buffer, &t[i], "chargingRateUnit") == 0)||                    get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start,&ChargingProfile.chargingRateUnit);||                    else if (jsoneq(buffer, &t[i], "startPeriod") == 0)||                    ChargingProfile.chargingSchedulePeriod[1].startPeriod= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "limit") == 0)||                    ChargingProfile.chargingSchedulePeriod[1].limit= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "numberPhases") == 0)||                    ChargingProfile.chargingSchedulePeriod[1].numberPhases= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    else if (jsoneq(buffer, &t[i], "minChargingRate") == 0)||                    ChargingProfile.minChargingRate= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                  }||                  //Take the action here||                  send_CommonResponse(MsgId,MsgType,"Accepted");||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||||||    /****************************************************************************************************/||    //                               TriggerMessageRequest||    /****************************************************************************************************/            ||                if(strcmp(MsgType,"TriggerMessage")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                     if (jsoneq(buffer, &t[i], "connectorId") == 0)||                     intVariable= StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                     if (jsoneq(buffer, &t[i], "requestedMessage") == 0)||                     {||                       if (jsoneq(buffer, &t[i+1], "BootNotification") == 0){charVariable=1;}||                       else if (jsoneq(buffer, &t[i+1], "DiagnosticsStatusNotification") == 0){charVariable=2;}||                       else if (jsoneq(buffer, &t[i+1], "FirmwareStatusNotification") == 0){charVariable=3;}||                       else if (jsoneq(buffer, &t[i+1], "Heartbeat") == 0){charVariable=4;}||                       else if (jsoneq(buffer, &t[i+1], "MeterValues") == 0){charVariable=5;}||                       else if (jsoneq(buffer, &t[i+1], "StatusNotification") == 0){charVariable=6;}||                     }||                  }||                  if(intVariable>NO_OF_CONNECTOR        ||      charVariable==0)||                    send_CommonResponse(MsgId,MsgType,"NotImplemented");||                  else||                  {||                    send_CommonResponse(MsgId,MsgType,"Accepted");//<-- send the status here||                    if(charVariable==1){send_BootNotification(&boot_resp);}||                    else if(charVariable==2){send_DiagnosticsStatusNotification(&DiagnosticsStatus);}||                    else if(charVariable==3){send_FirmwareStatusNotification(&FirmwareStatusNotification);}||                    else if(charVariable==4){send_Heartbeat(&hb_resp);}||                    else if(charVariable==5){send_MeterValues(intVariable,"Trigger");}||                    else if(charVariable==6){send_StatusNotification(intVariable,&notfn_param);}||                  }    ||                }||    /****************************************************************************************************/||    /****************************************************************************************************/||||||||    /****************************************************************************************************/||    //                               UnlockConnectorRequest||    /****************************************************************************************************/            ||                if(strcmp(MsgType,"UnlockConnector")==0)||                {||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "connectorId") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                    break;||                  }||                  // Take action here||                  send_CommonResponse(MsgId,MsgType,"Accepted");//<-- Send the response here||                }||    /****************************************************************************************************/||    /****************************************************************************************************/|||||||    /****************************************************************************************************/||    //                               UpdateFirmwareRequest||    /****************************************************************************************************/            ||                if(strcmp(MsgType,"UpdateFirmware")==0)||                {||                  char *location=NULL; char *retrieveDate=NULL;||                  for (char i = 0; i < var; i++) ||                  {||                    if (jsoneq(buffer, &t[i], "location") == 0)||                    {||                      location=(char*)pvPortMalloc((t[i+1].end - t[i+1].start+1)*sizeof(char));||                      if(location==NULL){/*traceLog the error here*/}||                      get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, location);||                    }||                    if (jsoneq(buffer, &t[i], "retries") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                     if (jsoneq(buffer, &t[i], "retrieveDate") == 0)||                     {||                       retrieveDate=(char*)pvPortMalloc((t[i+1].end - t[i+1].start+1)*sizeof(char));||                       if(retrieveDate==NULL){/*traceLog the error here*/}||                       get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, retrieveDate);||                     }||                    if (jsoneq(buffer, &t[i], "retryInterval") == 0)||                    intVariable=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||                  }||                  //Take the action here||                  send_UpdateFirmwareResponse(MsgId,MsgType);||                }||    /****************************************************************************************************/||    /****************************************************************************************************/            ||              }  ||            ||        }  ||       else if(notfn_value==CARD_TAPPED)    ||       {||          xEventGroupClearBits(EventHandle,AUTHENTICATION_ACCEPTED|AUTHENTICATION_REJECTED      \||                                                  |CONNECTOR_UNAVAILABLE|CONNECTOR_RESERVED);||          ||          if(connectorId==0 || connectorId>NO_OF_CONNECTOR)     // Check for invalid connector ID||          xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);||     else{||          if(Connector[connectorId-1].ConnectorStatus!=Connector_Unavailable){    // if connector is available||         ||          if(Connector[connectorId-1].Reservation!=NULL){          // if there is reservation  ||              if(strcmp(Connector[connectorId-1].Reservation->idTag,TagId)==0)||              {||                xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                if(Connector[connectorId-1].TransactionDetail==NULL)    // Agar koi charging nahi ho rahi hai..||                   StartCharging(connectorId);||                else if(Connector[connectorId-1].TransactionDetail!=NULL)||                  StopCharging(connectorId,"Local","");||              }||              else xEventGroupSetBits(EventHandle,CONNECTOR_RESERVED);||          } else{       // if there is no reservation||            ||            ||            ||/********************************************************************************************************/||       //                       ONLINE AUTHORIZATION PROCESS ||/********************************************************************************************************/        |||          if(   (boot_resp.Boot_Status==Boot_Accepted)     &&      Mode==ONLINE             )      ||          {||/*------------------------------------------------------------------------------------------------------*/||                             /*      Start Charging          */||/*------------------------------------------------------------------------------------------------------*/||                if(Connector[connectorId-1].TransactionDetail==NULL)     // Agar koi charging nahi ho rahi hai.||                {||                  send_Authorize(TagId, &authorize_resp);||                  if(authorize_resp.AuthorizeStatus==Authorize_Accepted)||                  {  ||                    xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                    Connector[connectorId-1].TransactionDetail=(TransactionDetail_t*)pvPortMalloc(sizeof(TransactionDetail_t));||                    strcpy(Connector[connectorId-1].TransactionDetail->idTag,TagId);       ||                    Connector[connectorId-1].TransactionDetail->Mode=ONLINE;||                    StartCharging(connectorId);||                  } ||                  else xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);                 ||                }||          ||/*------------------------------------------------------------------------------------------------------*/||                             /*      Stop Charging          */||/*------------------------------------------------------------------------------------------------------*/||                else if(Connector[connectorId-1].TransactionDetail!=NULL)                 // Agar pehle se hi koi charging ho rahi hai||                {||                  if(strcmp(TagId,Connector[connectorId-1].TransactionDetail->idTag)==0)   // if same card is used to stop charging ||                  {||                    xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                    StopCharging(connectorId,"Local","");||                  }||                  else||                  {||                    send_Authorize(TagId, &authorize_resp);||                    if(authorize_resp.AuthorizeStatus==Authorize_Accepted)||                    {||                      xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                      StopCharging(connectorId,"Local",TagId);||                    }||                    else||                      xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);||                  }||                }||              }// IF ONLINE||/********************************************************************************************************/||/********************************************************************************************************/ ||          ||          ||          ||/********************************************************************************************************/||         //                     OFFLINE AUTHORIZATION||/********************************************************************************************************/           ||      else if(Mode==OFFLINE && LocalAuthorizeOffline==1)||      {||      if(AllowOfflineTxForUnknownId==1){||              if(Connector[connectorId-1].TransactionDetail==NULL)     // Agar koi charging nahi ho rahi hai.||              {||                xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                Connector[connectorId-1].TransactionDetail=(TransactionDetail_t*)pvPortMalloc(sizeof(TransactionDetail_t));||                strcpy(Connector[connectorId-1].TransactionDetail->idTag,TagId);  ||                Connector[connectorId-1].TransactionDetail->Mode=OFFLINE;||                StartCharging(connectorId);||              }||              else if(Connector[connectorId-1].TransactionDetail!=NULL)        // Agar pehle se hi koi charging ho rahi hai||              {||                if(strcmp(TagId,Connector[connectorId-1].TransactionDetail->idTag)==0)   // if same card is used to stop charging ||                {||                  xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                  StopCharging(connectorId,"Local","");||                }||                else xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);||              }||           }||      ||      ||      else if(AllowOfflineTxForUnknownId==0){||              if(Connector[connectorId-1].TransactionDetail==NULL)     // Agar koi charging nahi ho rahi hai.||              {||                if(OfflineAuthorized(TagId))||                {||                  xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                  Connector[connectorId-1].TransactionDetail=(TransactionDetail_t*)pvPortMalloc(sizeof(TransactionDetail_t));||                  strcpy(Connector[connectorId-1].TransactionDetail->idTag,TagId);       ||                  Connector[connectorId-1].TransactionDetail->Mode=OFFLINE;||                  StartCharging(connectorId);||                }||                else xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);||              }||              else if(Connector[connectorId-1].TransactionDetail!=NULL)        // Agar pehle se hi koi charging ho rahi hai||              {||                if(strcmp(TagId,Connector[connectorId-1].TransactionDetail->idTag)==0)   // if same card is used to stop charging ||                {||                  xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                  StopCharging(connectorId,"Local","");||                }||                else // if different card is used to stop charging||                {||                  if(OfflineAuthorized(TagId))||                  {||                    xEventGroupSetBits(EventHandle,AUTHENTICATION_ACCEPTED);||                    StopCharging(connectorId,"Local","");||                  }||                  else xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);||                } ||              }||           }||         }// IF OFFLINE||         else xEventGroupSetBits(EventHandle,AUTHENTICATION_REJECTED);||/********************************************************************************************************/||/********************************************************************************************************/ ||          }// if there is no reservation||          } // if connector is Available||          else xEventGroupSetBits(EventHandle,CONNECTOR_UNAVAILABLE);||          }// if valid connector id||        }// if card is tapped||       ||}// if Task received task Notification.||/********************************************************************************************/  || ||  else if(HeartbeatFlag && Mode==ONLINE)||  {||    send_Heartbeat(&hb_resp);||    HeartbeatFlag=0;||  }||/********************************************************************************************/  |||  else if(MeterValuesClockFlag && Mode==ONLINE)||  {||    for(uint8_t b=0; b<NO_OF_CONNECTOR; b++)||    { ||        send_MeterValues((b+1),"Sample.Clock");||    }||    MeterValuesClockFlag=0;||  }||/********************************************************************************************/|||  else if(MeterValuesPeriodicFlag)||  {||    for(uint8_t b=0; b<NO_OF_CONNECTOR; b++)||    {||      if(Connector[b].TransactionDetail!=NULL) ||        send_MeterValues((b+1),"Sample.Periodic");||    }||     MeterValuesPeriodicFlag=0;||  }||  ||  ||/********************************************************************************************/||  else if(BootFlag)||  {||    if(send_BootNotification(&boot_resp)==0){traceLog("E1");}||  else||  {||    if(boot_resp.Boot_Status==Boot_Rejected)||    {||      if(boot_resp.interval==0)boot_resp.interval=60;||      if( xTimerChangePeriod( Boot_Timer_Handle, pdMS_TO_TICKS(boot_resp.interval*1000),pdMS_TO_TICKS(1000) )==pdFAIL){traceLog("E2");}||    }||    else if(boot_resp.Boot_Status==Boot_Pending)||    {||      if(boot_resp.interval==0)boot_resp.interval=60;||      if( xTimerChangePeriod( Boot_Timer_Handle, pdMS_TO_TICKS(boot_resp.interval*1000),pdMS_TO_TICKS(1000) )==pdFAIL){traceLog("E3");}||    }||    else if(boot_resp.Boot_Status==Boot_Accepted)||    {||       if(boot_resp.interval==0) boot_resp.interval=500;   // If interval is 0, then chargepoint can choose heartbeat interval on its own||       Heartbeat_Timer_Handle=xTimerCreate("heartbeat_timer",pdMS_TO_TICKS(boot_resp.interval*1000),pdTRUE,0,Heartbeat_Timer);||       if(Heartbeat_Timer_Handle==NULL) traceLog("E4");||       else{ if(xTimerStart(Heartbeat_Timer_Handle, pdMS_TO_TICKS(500))==pdFAIL){traceLog("E5");}}||       HeartbeatInterval=boot_resp.interval;||       xTimerDelete(Boot_Timer_Handle, pdMS_TO_TICKS(5000));||       ||       strcpy(notfn_param.errorCode,"NoError");||       for(char n=0; n<=NO_OF_CONNECTOR; n++)   ||       send_StatusNotification(n,&notfn_param);|||       send_MeterValues(1,"Sample.Clock");||        ||       MeterValuesClock_Handle=xTimerCreate("MVClk",pdMS_TO_TICKS(10000),pdTRUE,0,MeterValuesClock);||       if(MeterValuesClock_Handle==NULL) {traceLog("E15");}||       else{ if(xTimerStart(MeterValuesClock_Handle, pdMS_TO_TICKS(1000))==pdFAIL){traceLog("E16");}}    ||     }||  }||  BootFlag=0;||  }||  ||/********************************************************************************************/  || }// while Restart flag==0;||}// While 1||}// Task end||||void send_CommonResponse(char* MsgId, char* MsgType, char* status)||{||  int var;      ||traceLog("Making commonresp obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 3 );	||        jwArr_string(MsgId);||        //jwArr_string(MsgType);||		jwArr_object();							||			jwObj_string( "status", status);	||  		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||        Send_to_server(TransmitBuffer);      ||}||||void send_UpdateFirmwareResponse(char* MsgId, char* MsgType)||{||  int var;      ||traceLog("Making updatefirmresp obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 3 );	||        jwArr_string(MsgId);||        //jwArr_string(MsgType);||		jwArr_object();							||			//Empty object||  		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||        Send_to_server(TransmitBuffer);   ||}|||void send_GetLocalListVersionResponse(char* MsgId, int *listVersion)||{||  int var;      ||traceLog("Making locllistversnresp obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 3 );	||        jwArr_string(MsgId);||       // jwArr_string("GetLocalListVersion");||		jwArr_object();							||			jwObj_int( "listVersion", *listVersion);	||  		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||        Send_to_server(TransmitBuffer);||}|||||void send_GetConfigurationResponse(uint32_t *GetConfigurationFlag, char*MsgId)||{||   int var; char res[4];      ||traceLog("Making getconfigresp obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 3 );	||        jwArr_string(MsgId);||        //jwArr_string("GetConfiguration");||		jwArr_object();							||                          jwObj_array("configurationKey");||if(GetConfigurationFlag[0]&Flag_AllowOfflineTxForUnknownId){jwArr_object(); jwObj_string("key","AllowOfflineTxForUnknownId");||jwObj_string("readonly","false"); intToStr(AllowOfflineTxForUnknownId,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_AuthorizationCacheEnabled){jwArr_object(); jwObj_string("key","AuthorizationCacheEnabled");||jwObj_string("readonly","false"); intToStr(AuthorizationCacheEnabled,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_AuthorizeRemoteTxRequests){jwArr_object(); jwObj_string("key","AuthorizeRemoteTxRequests");||jwObj_string("readonly","false"); intToStr(AuthorizeRemoteTxRequests,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_BlinkRepeat){jwArr_object(); jwObj_string("key","BlinkRepeat");||jwObj_string("readonly","false"); intToStr(BlinkRepeat,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_ClockAlignedDataInterval){jwArr_object(); jwObj_string("key","ClockAlignedDataInterval");||jwObj_string("readonly","false"); intToStr(ClockAlignedDataInterval,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_ConnectionTimeOut){jwArr_object(); jwObj_string("key","ConnectionTimeOut");||jwObj_string("readonly","false"); intToStr(ConnectionTimeOut,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_HeartbeatInterval){jwArr_object(); jwObj_string("key","HeartbeatInterval");||jwObj_string("readonly","false"); intToStr(HeartbeatInterval,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_LightIntensity){jwArr_object(); jwObj_string("key","LightIntensity");||jwObj_string("readonly","false"); intToStr(LightIntensity,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_LocalAuthorizeOffline){jwArr_object(); jwObj_string("key","LocalAuthorizeOffline");||jwObj_string("readonly","false"); intToStr(LocalAuthorizeOffline,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_LocalPreAuthorize){jwArr_object(); jwObj_string("key","LocalPreAuthorize");||jwObj_string("readonly","false"); intToStr(LocalPreAuthorize,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_MaxEnergyOnInvalidId){jwArr_object(); jwObj_string("key","MaxEnergyOnInvalidId");||jwObj_string("readonly","false"); intToStr(MaxEnergyOnInvalidId,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_MeterValuesAlignedDataMaxLength){jwArr_object(); jwObj_string("key","MeterValuesAlignedDataMaxLength");||jwObj_string("readonly","false"); intToStr(MeterValuesAlignedDataMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_MeterValuesSampledDataMaxLength){jwArr_object(); jwObj_string("key","MeterValuesSampledDataMaxLength");||jwObj_string("readonly","false"); intToStr(MeterValuesSampledDataMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_MeterValueSampleInterval){jwArr_object(); jwObj_string("key","MeterValueSampleInterval");||jwObj_string("readonly","false"); intToStr(MeterValueSampleInterval,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_MinimumStatusDuration){jwArr_object(); jwObj_string("key","MinimumStatusDuration");||jwObj_string("readonly","false"); intToStr(MinimumStatusDuration,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_NumberOfConnectors){jwArr_object(); jwObj_string("key","NumberOfConnectors");||jwObj_string("readonly","false"); intToStr(NumberOfConnectors,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_ResetRetries){jwArr_object(); jwObj_string("key","ResetRetries");||jwObj_string("readonly","false"); intToStr(ResetRetries,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_StopTransactionOnEVSideDisconnect){jwArr_object(); jwObj_string("key","StopTransactionOnEVSideDisconnect");||jwObj_string("readonly","false"); intToStr(StopTransactionOnEVSideDisconnect,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_StopTransactionOnInvalidId){jwArr_object(); jwObj_string("key","StopTransactionOnInvalidId");||jwObj_string("readonly","false"); intToStr(StopTransactionOnInvalidId,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[0]&Flag_StopTxnAlignedDataMaxLength){jwArr_object(); jwObj_string("key","StopTxnAlignedDataMaxLength");||jwObj_string("readonly","false"); intToStr(StopTxnAlignedDataMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_StopTxnSampledDataMaxLength){jwArr_object(); jwObj_string("key","StopTxnSampledDataMaxLength");||jwObj_string("readonly","false"); intToStr(StopTxnSampledDataMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_SupportedFeatureProfilesMaxLength){jwArr_object(); jwObj_string("key","SupportedFeatureProfilesMaxLength");||jwObj_string("readonly","false"); intToStr(SupportedFeatureProfilesMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_TransactionMessageAttempts){jwArr_object(); jwObj_string("key","TransactionMessageAttempts");||jwObj_string("readonly","false"); intToStr(TransactionMessageAttempts,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_UnlockConnectorOnEVSideDisconnect){jwArr_object(); jwObj_string("key","UnlockConnectorOnEVSideDisconnect");||jwObj_string("readonly","false"); intToStr(UnlockConnectorOnEVSideDisconnect,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_TransactionMessageRetryInterval){jwArr_object(); jwObj_string("key","TransactionMessageRetryInterval");||jwObj_string("readonly","false"); intToStr(TransactionMessageRetryInterval,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_WebSocketPingInterval){jwArr_object(); jwObj_string("key","WebSocketPingInterval");||jwObj_string("readonly","false"); intToStr(WebSocketPingInterval,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_LocalAuthListEnabled){jwArr_object(); jwObj_string("key","LocalAuthListEnabled");||jwObj_string("readonly","false"); intToStr(LocalAuthListEnabled,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_LocalAuthListMaxLength){jwArr_object(); jwObj_string("key","LocalAuthListMaxLength");||jwObj_string("readonly","false"); intToStr(LocalAuthListMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_SendLocalListMaxLength){jwArr_object(); jwObj_string("key","SendLocalListMaxLength");||jwObj_string("readonly","false"); intToStr(SendLocalListMaxLength,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_ReserveConnectorZeroSupported){jwArr_object(); jwObj_string("key","ReserveConnectorZeroSupported");||jwObj_string("readonly","false"); intToStr(ReserveConnectorZeroSupported,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_ChargeProfileMaxStackLevel){jwArr_object(); jwObj_string("key","ChargeProfileMaxStackLevel");||jwObj_string("readonly","false"); intToStr(ChargeProfileMaxStackLevel,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_ChargingScheduleMaxPeriods){jwArr_object(); jwObj_string("key","ChargingScheduleMaxPeriods");||jwObj_string("readonly","false"); intToStr(ChargingScheduleMaxPeriods,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_ConnectorSwitch3to1PhaseSupported){jwArr_object(); jwObj_string("key","ConnectorSwitch3to1PhaseSupported");||jwObj_string("readonly","false"); intToStr(ConnectorSwitch3to1PhaseSupported,res,0);   jwObj_string("value",res); jwEnd();}||if(GetConfigurationFlag[1]&Flag_MaxChargingProfilesInstalled){jwArr_object(); jwObj_string("key","MaxChargingProfilesInstalled");||jwObj_string("readonly","false"); intToStr(MaxChargingProfilesInstalled,res,0);   jwObj_string("value",res); jwEnd();}||                          jwEnd();||  		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||        Send_to_server(TransmitBuffer);   ||}|||uint8_t send_BootNotification(BootNotificationResp_t* boot_resp)||{ ||        char msgid[30]="e54da891-99fa-4546-98ab-3e";||	int var;||        jsmn_parser p;||        jsmntok_t t[BootNotificationTokens]; ||        jsmn_init(&p);||traceLog("Making bootnotfn obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("BootNotification");||		jwArr_object();							||			jwObj_string( "chargePointVendor", ChargePoint.chargePointVendor);||			jwObj_string( "chargePointModel", ChargePoint.chargePointModel);||                        if(strcmp(ChargePoint.chargePointSerialNumber,"")!=0)||                        jwObj_string( "chargePointSerialNumber", ChargePoint.chargePointSerialNumber);||                        ||                        if(strcmp(ChargePoint.chargeBoxSerialNumber,"")!=0)||                        jwObj_string( "chargeBoxSerialNumber", ChargePoint.chargeBoxSerialNumber);||                        ||                        if(strcmp(ChargePoint.firmwareVersion,"")!=0)||                        jwObj_string( "firmwareVersion", ChargePoint.firmwareVersion);||                        ||                        if(strcmp(ChargePoint.iccid,"")!=0)||                        jwObj_string( "iccid", ChargePoint.iccid);||                        ||                        if(strcmp(ChargePoint.imsi,"")!=0)||                        jwObj_string( "imsi", ChargePoint.imsi);||                        ||                        if(strcmp(ChargePoint.meterType,"")!=0)||                        jwObj_string( "meterType", ChargePoint.meterType);||                        ||                        if(strcmp(ChargePoint.meterSerialNumber,"")!=0)||                        jwObj_string( "meterSerialNumber", ChargePoint.meterSerialNumber);||  		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||        Send_to_server(TransmitBuffer);      ||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse"); ||return 0;}||        if (jsoneq(buffer, &t[2], msgid) == 0)||        for (char i = 0; i < var; i++) ||        {||          if (jsoneq(buffer, &t[i], "interval") == 0)||          boot_resp->interval=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||          else if (jsoneq(buffer, &t[i], "currentTime") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, boot_resp->current_time);||          else if (jsoneq(buffer, &t[i], "status") == 0)||          {||            if (jsoneq(buffer, &t[i+1], "Accepted") == 0)       {boot_resp->Boot_Status=Boot_Accepted;}||            if (jsoneq(buffer, &t[i+1], "Rejected") == 0)        {boot_resp->Boot_Status=Boot_Rejected;}||            if (jsoneq(buffer, &t[i+1], "Pending") == 0)        {boot_resp->Boot_Status=Boot_Pending;}||          }||        }||      else return 0;||      return 1;||}|||uint8_t send_Heartbeat(Heartbeat_resp_t* hb_resp)||{||        char msgid[30]="e54da891-99fa-4546-98ab-3e";||	int var;||        jsmn_parser p;||        jsmntok_t t[HeartbeatTokens]; ||        jsmn_init(&p);||traceLog("Making heartbt obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("Heartbeat");||		jwArr_object();							||			//Empty object.||		jwEnd();||	var= jwClose();	||traceLog(jwErrorToString(var));||        Send_to_server(TransmitBuffer);||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse");return 0;}||        if (jsoneq(buffer, &t[2], msgid) == 0)||        for (char i = 0; i < var; i++) ||        {||          if (jsoneq(buffer, &t[i], "currentTime") == 0)||          {get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, hb_resp->currentTime);||          break;}||        }||      else return 0;||      return 1;||}||||uint8_t send_StatusNotification(uint8_t connectorId,StatusNotification_t* notfn_param)||{        ||        char msgid[30]="e54da891-99fa-4546-98ab-3e";||	int var; char cp[30];||        OCPP_Get_Time(cp);||        jsmn_parser p;||        jsmntok_t t[StatusNotificationTokens]; ||        jsmn_init(&p);||traceLog("Making statusnotfn obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("StatusNotification");||		jwArr_object();							||			jwObj_int( "connectorId", connectorId);||                        if(connectorId==0)||			jwObj_string( "errorCode", ChargePoint.ChargePointError);||                        else||                         jwObj_string( "errorCode", notfn_param->errorCode);||                        ||                        if(strcmp(notfn_param->info,"")!=0)||                        jwObj_string( "info", notfn_param->info);||                        ||                        if(connectorId>0){||                        if(Connector[connectorId-1].ConnectorStatus==Connector_Available)||                        jwObj_string( "status","Available");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_Charging)||                        jwObj_string( "status","Charging");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_Faulted)||                        jwObj_string( "status","Faulted");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_Finishing)||                        jwObj_string( "status","Finishing");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_Preparing)||                        jwObj_string( "status","Preparing");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_Reserved)||                        jwObj_string( "status","Reserved");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_SuspendedEV)||                        jwObj_string( "status","SuspendedEV");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_SuspendedEVSE)||                        jwObj_string( "status","SuspendedEVSE");||                        else if(Connector[connectorId-1].ConnectorStatus==Connector_Unavailable)||                        jwObj_string( "status","Unavailable");}||                         ||                        else if(connectorId==0){||                        if(ChargePoint.ChargePointStatus==Connector_Available)||                        jwObj_string( "status","Available");||                        else if(ChargePoint.ChargePointStatus==Connector_Faulted)||                        jwObj_string( "status","Faulted");||                        else if(ChargePoint.ChargePointStatus==Connector_Reserved)||                        jwObj_string( "status","Reserved");||                        else if(ChargePoint.ChargePointStatus==Connector_Unavailable)||                        jwObj_string( "status","Unavailable");}||                           ||                        ||                        jwObj_string( "timestamp",cp);||                         if(strcmp(ChargePoint.vendorId,"")!=0)||                        jwObj_string( "vendorId", ChargePoint.vendorId);||                        ||                         if(strcmp(notfn_param->vendorErrorCode,"")!=0)||                        jwObj_string( "vendorErrorCode", notfn_param->vendorErrorCode);||  		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||if(Mode==OFFLINE)||{/*Store locally */|| return 1;}||        Send_to_server(TransmitBuffer);      ||       var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse"); return 0;}||        if (jsoneq(buffer, &t[2], msgid) == 0)||        {traceLog("Recived valid response");return 1;}||      return 0;||}|||uint8_t send_StartTransaction(uint8_t connectorId,StartTransactionResp_t *transaction_resp)||{||        MeterDetails_t MeterDetails;||        xQueuePeek(MeterQueue[connectorId-1],&MeterDetails,0);||        char msgid[30]="e54da891-99fa-4546-98ab-3e"; char time[30];||        transaction_resp->TransactionStatus=Transaction_Blocked;||        OCPP_Get_Time(time);||	int var;||        jsmn_parser p;||        jsmntok_t t[StartTransactionTokens]; ||        jsmn_init(&p);||        transaction_resp->TransactionStatus=Transaction_Blocked;||traceLog("Making start_transtn obj..");||        jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("StartTransaction");||		jwArr_object();||                        jwObj_int( "connectorId",connectorId );||			jwObj_string( "idTag",Connector[connectorId-1].TransactionDetail->idTag);||                        jwObj_int( "meterStart",(int)(MeterDetails.MeterData.R_PhaseActiveEnergy*1000) );||                        jwObj_string( "timestamp",time );||                          || 		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||if(Mode==OFFLINE)||{||Connector[connectorId-1].TransactionDetail->TransactionId=OfflineTransactionId;||OfflineTransactionId++;||transaction_resp->TransactionStatus=Transaction_Accepted;||/*Store locally */|| return 1;}|||        Send_to_server(TransmitBuffer);||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse"); return 0;}||        if (jsoneq(buffer, &t[2], msgid) == 0)||        for (char i = 0; i < var; i++) ||        {||          if (jsoneq(buffer, &t[i], "expiryDate") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, transaction_resp->expiryDate);||          else if (jsoneq(buffer, &t[i], "parentIdTag") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, transaction_resp->parentIdTag);||          else if (jsoneq(buffer, &t[i], "status") == 0)||          {||            if (jsoneq(buffer, &t[i+1], "Accepted") == 0)       {transaction_resp->TransactionStatus=Transaction_Accepted;}||            if (jsoneq(buffer, &t[i+1], "Blocked") == 0)        {transaction_resp->TransactionStatus=Transaction_Blocked;}||            if (jsoneq(buffer, &t[i+1], "Expired") == 0)        {transaction_resp->TransactionStatus=Transaction_Expired;}||            if (jsoneq(buffer, &t[i+1], "Invalid") == 0)        {transaction_resp->TransactionStatus=Transaction_Invalid;}||            if (jsoneq(buffer, &t[i+1], "ConcurrentTx") == 0)   {transaction_resp->TransactionStatus=Transaction_ConcurrentTx;}||          }||          else if (jsoneq(buffer, &t[i], "transactionId") == 0)||            Connector[connectorId-1].TransactionDetail->TransactionId=StrToInteger(t[i+1].end - t[i+1].start,  buffer + t[i+1].start);||        }||      else return 0;||      return 1;||}|||uint8_t send_StopTransaction(uint8_t connectorId, char *idTag, char *reason, StopTransactionResp_t *stop_transaction_resp)||{||        MeterDetails_t MeterDetails;||        xQueuePeek(MeterQueue[connectorId-1],&MeterDetails,0);||        char msgid[30]="e54da891-99fa-4546-98ab-3e"; char time[30];||        OCPP_Get_Time(time);||	int var;||        jsmn_parser p;||        jsmntok_t t[StopTransactionTokens]; ||        jsmn_init(&p);||traceLog("Making stop_transtn obj..");||        jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	 jwArr_string(msgid); jwArr_string("StopTransaction");||		jwArr_object();||                        if(strcmp(idTag,"")!=0)||                        jwObj_string( "idTag",idTag );||                        jwObj_int( "meterStop",(int)(MeterDetails.MeterData.R_PhaseActiveEnergy*1000));||                        jwObj_string( "timestamp",time);||                        jwObj_int( "transactionId",Connector[connectorId-1].TransactionDetail->TransactionId );||                        // End reservation if any||                        for(char i=0; i<NO_OF_CONNECTOR; i++)||                        { if(Connector[i].Reservation!=NULL)||                          if(strcmp(Connector[i].Reservation->idTag,Connector[connectorId-1].TransactionDetail->idTag)==0)||                          {jwObj_int( "reservationId", Connector[i].Reservation->reservationId);||                          vPortFree(Connector[i].Reservation); Connector[i].Reservation=NULL;||                          break;}||                        }||                        ||                        if(strcmp(reason,"")!=0)||                        jwObj_string( "reason",reason);||                        ||                jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));|||if(Mode==OFFLINE)||{/*Store locally */||   vPortFree(Connector[connectorId-1].TransactionDetail);         // free the space||   Connector[connectorId-1].TransactionDetail=NULL;|| return 1;}|||        vPortFree(Connector[connectorId-1].TransactionDetail);         // free the space||        Connector[connectorId-1].TransactionDetail=NULL;||        Send_to_server(TransmitBuffer);||      ||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse");}||        if (jsoneq(buffer, &t[2], msgid) == 0)||        for (char i = 0; i < var; i++) ||        {||          if (jsoneq(buffer, &t[i], "expiryDate") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, stop_transaction_resp->expiryDate);||          else if (jsoneq(buffer, &t[i], "parentIdTag") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, stop_transaction_resp->parentIdTag);||          else if (jsoneq(buffer, &t[i], "status") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, stop_transaction_resp->status);||        }||      return 1;||}|||/*||void send_DataTransfer(DataTransfer_t* data_param, DataTransferResp_t* data_resp)||{||	char msgid[9]="12345678";||        char buffer[DataTransferMsgSize], resp_msgid[10];||	unsigned int buflen= DataTransferMsgSize;||	int var;||        jsmn_parser p;||        jsmntok_t t[DataTransferTokens]; ||        jsmn_init(&p);||traceLog("Making data_transfer obj..");||	jwOpen( buffer, buflen, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("DataTransfer");||		jwArr_object();	||                    jwObj_object("data");||                            jwObj_string( "vendorId", ChargePoint.vendorId);||                            jwObj_string( "UserIdTag", data_param->UserIdTag);||                             if(data_param->MessageType==StartSwapTransRequest)||                            {   jwObj_int( "UserBatteryID", Connector[data_param->connectorId].battery.battery_id);||                                jwObj_int( "UserBatterySoC", Connector[data_param->connectorId].battery.SoC);||                                jwObj_int( "UserBatterySoH", Connector[data_param->connectorId].battery.SoH);       }||                            ||                           else{jwObj_int( "ChargedBatteryID",  Connector[data_param->connectorId].battery.battery_id);||                                jwObj_int( "ChargedBatterySoC", Connector[data_param->connectorId].battery.SoC);||                                jwObj_int( "ChargedBatterySoH", Connector[data_param->connectorId].battery.SoH);    }||                            ||                                jwObj_string( "timestamp", timestamp);||                                if(data_param->MessageType==StartSwapTransRequest)||                                jwObj_string( "messageId","StartSwapTransRequest");||                                else{||                                jwObj_int( "TransactionID", data_param->TransactionID);  ||                                jwObj_string( "messageId","StopSwapTransRequest");||                                jwObj_string( "reason", data_param->reason);    }||                   jwEnd();||                jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||        Send_to_server(buffer);||      ||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse");}||        get_val(t[2].end - t[2].start,  buffer + t[2].start, resp_msgid);||        if(strcmp(msgid,resp_msgid)==0)||        for (char i = 0; i < var; i++) ||        {||          if (jsoneq(buffer, &t[i], "expirydate") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->expirydate);||          else if (jsoneq(buffer, &t[i], "batteryStatus") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->batteryStatus);||          else if (jsoneq(buffer, &t[i], "soh") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->soh);||          else if (jsoneq(buffer, &t[i], "transactionId") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->transactionId);||          else if (jsoneq(buffer, &t[i], "previousUserId") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->previousUserId);||          else if (jsoneq(buffer, &t[i], "status") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->status);||          else if (jsoneq(buffer, &t[i], "transactionStatus") == 0)||          get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, data_resp->transactionStatus);||        }||}|||*/|||void send_Authorize(char *id_tag, AuthorizeResp_t *authorize_resp)||{||	char msgid[30]="e54da891-99fa-4546-98ab-3e";||	int var; ||        LocalAuthorizationList_t LocalList;|| /*---------------------------------------------------------------------------*/       ||        authorize_resp->AuthorizeStatus=Authorize_Waiting;||        strcpy(LocalList.parentIdTag,"");||        strcpy(LocalList.expiryDate,"");|| /*---------------------------------------------------------------------------*/       ||        jsmn_parser p;||        jsmntok_t t[AuthorizeMsgTokens]; ||        jsmn_init(&p);||traceLog("Making Authz obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("Authorize");||		jwArr_object();							||			jwObj_string( "idTag", id_tag);||		jwEnd();||	var= jwClose();||traceLog(jwErrorToString(var));||  if(Send_to_server(TransmitBuffer))||  {||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) {traceLog("Failed to parse");}||     else{      // if parsed successfully||          if (jsoneq(buffer, &t[2], msgid) == 0)||          {||            strcpy(LocalList.idTag,id_tag);||            for (char i = 0; i < var; i++) ||            {||              if (jsoneq(buffer, &t[i], "status") == 0)||              {||                if (jsoneq(buffer, &t[i+1], "Accepted") == 0)       {authorize_resp->AuthorizeStatus=LocalList.status=Authorize_Accepted;}||                if (jsoneq(buffer, &t[i+1], "Blocked") == 0)        {authorize_resp->AuthorizeStatus=LocalList.status=Authorize_Blocked;}||                if (jsoneq(buffer, &t[i+1], "Expired") == 0)        {authorize_resp->AuthorizeStatus=LocalList.status=Authorize_Expired;}||                if (jsoneq(buffer, &t[i+1], "Invalid") == 0)        {authorize_resp->AuthorizeStatus=LocalList.status=Authorize_Invalid;}||                if (jsoneq(buffer, &t[i+1], "ConcurrentTx") == 0)   {authorize_resp->AuthorizeStatus=LocalList.status=Authorize_ConcurrentTx;}||              }||              else if (jsoneq(buffer, &t[i], "expiryDate") == 0)||              get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, LocalList.expiryDate);||              else if (jsoneq(buffer, &t[i], "parentIdTag") == 0)||              get_val(t[i+1].end - t[i+1].start,  buffer + t[i+1].start, LocalList.parentIdTag);||            }||            //AddToAuthorizationCache(&LocalList);||        }||     }||   }||}|||void send_MeterValues(uint8_t connectorId, char* context)||{||        MeterDetails_t MeterDetails;||        xQueuePeek(MeterQueue[connectorId-1],&MeterDetails,0);||	char msgid[30]="e54da891-99fa-4546-98ab-3e";||        char temp[30];||        int var;||        jsmn_parser p;||        jsmntok_t t[MeterValuesMsgTokens]; ||        jsmn_init(&p);||traceLog("Making MeterValues obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("MeterValues");||		jwArr_object();							||			jwObj_int( "connectorId", connectorId);||                        if(strcmp(context,"Sample.Clock")!=0)   ||                        jwObj_int( "transactionId", Connector[connectorId-1].TransactionDetail->TransactionId);||                        ||                        jwObj_array("meterValue");||                              jwArr_object();||                               //Voltage||                                    jwObj_array("sampledValue");||                                          jwArr_object();||                                          ftoa(MeterDetails.MeterData.R_PhaseVoltage,temp,2);||jwObj_string("value",temp); jwObj_string("context",context);jwObj_string("format","Raw"); jwObj_string("measurand","Voltage");jwObj_string("phase","L1-N");jwObj_string("location","Inlet"); jwObj_string("unit","V");            ||                                          jwEnd(); ||                                    jwEnd();||                                    OCPP_Get_Time(temp);||                                    jwObj_string("timestamp", temp);||                             jwEnd();||                             ||                              //Current||                             jwArr_object();||                                    jwObj_array("sampledValue");||                                          jwArr_object();||                                          ftoa(MeterDetails.MeterData.R_PhaseCurrent,temp,2);||jwObj_string("value",temp); jwObj_string("context",context);jwObj_string("format","Raw"); jwObj_string("measurand","Current.Import");jwObj_string("phase","L1");jwObj_string("location","Inlet"); jwObj_string("unit","A");            ||                                          jwEnd(); ||                                    jwEnd();||                                    OCPP_Get_Time(temp);||                                    jwObj_string("timestamp", temp);||                             jwEnd();||                             ||                             //Energy||                             jwArr_object();||                                    jwObj_array("sampledValue");||                                          jwArr_object();||                                          ftoa((MeterDetails.MeterData.R_PhaseActiveEnergy*1000),temp,0);||jwObj_string("value",temp); jwObj_string("context",context);jwObj_string("format","Raw"); jwObj_string("measurand","Energy.Active.Import.Interval");jwObj_string("phase","L1");jwObj_string("location","Inlet"); jwObj_string("unit","Wh");            ||                                          jwEnd(); ||                                    jwEnd();||                                    OCPP_Get_Time(temp);||                                    jwObj_string("timestamp", temp);||                             jwEnd();||                             ||                             //Temperature||                             jwArr_object();||                                    jwObj_array("sampledValue");||                                          jwArr_object();||                                          ftoa(28,temp,2);||jwObj_string("value",temp); jwObj_string("context",context);jwObj_string("format","Raw"); jwObj_string("measurand","Temperature");jwObj_string("phase","L1");jwObj_string("location","Inlet"); jwObj_string("unit","Celsius");            ||                                          jwEnd(); ||                                    jwEnd();||                                    OCPP_Get_Time(temp);||                                    jwObj_string("timestamp", temp);||                             jwEnd();||                             ||                       jwEnd();||                    jwEnd();||                    ||	var= jwClose();||traceLog(jwErrorToString(var));|||        Send_to_server(TransmitBuffer);||        var = jsmn_parse(&p, buffer, strlen(buffer), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) ||{traceLog("Failed to parse");}||        get_val(t[2].end - t[2].start,  buffer + t[2].start, temp);||        //if(strcmp(msgid,resp_msgid)==0)||   ||}|||void send_DiagnosticsStatusNotification(DiagnosticsStatus_t *status)||{||        char msgid[9]="12345678";||	signed int var;||traceLog("Making diag_stat_notfn obj..");||        jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("DiagnosticsStatusNotification");||		jwArr_object();||                        if(*status==D_Idle)||                          jwObj_string( "status", "Idle");||                        if(*status==Uploaded)||                          jwObj_string( "status", "Uploaded");||                        if(*status==UploadFailed)||                          jwObj_string( "status", "UploadFailed");||                        if(*status==Uploading)||                          jwObj_string( "status", "Uploading");||		jwEnd();||	var= jwClose();							||traceLog(jwErrorToString(var));||Send_to_server(TransmitBuffer);||}|||void send_FirmwareStatusNotification(FirmwareStatusNotification_t *status)||{||	char msgid[9]="12345678";||	int var;||traceLog("Making firm_stat_notfn obj..");||	jwOpen( TransmitBuffer, TRANSMIT_BUFFER_SIZE, JW_ARRAY, JW_COMPACT );				||	jwArr_int( 2 );	||        jwArr_string(msgid);||        jwArr_string("FirmwareStatusNotification");||		jwArr_object();||                        if(*status==Downloaded)||                          jwObj_string( "status", "Downloaded");||                        if(*status==DownloadFailed)||                          jwObj_string( "status", "DownloadFailed");||                        if(*status==Downloading)||                          jwObj_string( "status", "Downloading");||                        if(*status==F_Idle)||                          jwObj_string( "status", "Idle");||                        if(*status==InstallationFailed)||                          jwObj_string( "status", "InstallationFailed");||                        if(*status==Installing)||                          jwObj_string( "status", "Installing");||                        if(*status==Installed)||                          jwObj_string( "status", "Installed");||    		jwEnd();||        var= jwClose();||traceLog(jwErrorToString(var));||Send_to_server(TransmitBuffer);||}|||||||void AddLocalList(LocalAuthorizationList_t *LocalList)||{||  FIL Authfile; // File||  char string[150]; UINT temp; signed int var=0; ||  FSIZE_t fpointer=0; ||  jsmn_parser p;||  jsmntok_t t[10]; ||  jsmn_init(&p);|| ||  fresult=f_open (&Authfile,"/Auth.txt",FA_WRITE|FA_READ|FA_OPEN_ALWAYS);||  fpointer=0;||  do{||    f_read (&Authfile,string,150,&temp);||     if(temp>1)||     {||       var = jsmn_parse(&p, string, strlen(string), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) {traceLog("Failed to parse");}||      else{      // if parsed successfully||             if (jsoneq(string, &t[2], LocalList->idTag) == 0)||             {||               f_lseek(&Authfile,fpointer);||               break;||            }||          }||       fpointer+=150;||     }||  }while(f_eof(&Authfile)==0);||      ||  jwOpen( string, 150, JW_OBJECT, JW_COMPACT );				||	jwObj_string( "idTag", LocalList->idTag);||        if(strcmp(LocalList->expiryDate,"")!=0)||        jwObj_string( "expiryDate", LocalList->expiryDate);||        if(strcmp(LocalList->parentIdTag,"")!=0)||        jwObj_string( "parentIdTag", LocalList->parentIdTag);||        ||        if(LocalList->status==Authorize_Accepted)||          jwObj_string( "status", "Accepted");||        else if(LocalList->status==Authorize_Blocked)||          jwObj_string( "status", "Blocked");||        else if(LocalList->status==Authorize_Expired)||          jwObj_string( "status", "Expired");||        else if(LocalList->status==Authorize_Invalid)||          jwObj_string( "status", "Invalid");||        else if(LocalList->status==Authorize_ConcurrentTx)||          jwObj_string( "status", "ConcurrentTx");||        jwClose();||  if(fresult==FR_OK){||                      for(char i=(strlen(string)+1); i<150; i++)||                      string[i]='x';  ||                      f_write(&Authfile,string,150,&temp);||                     }||  f_close(&Authfile);||  ||}|||uint8_t OfflineAuthorized(char* idTag)||{||  FIL Authfile; // File||  char string[150]; UINT temp; signed int var=0; ||  FSIZE_t fpointer=0;||  jsmn_parser p;||  jsmntok_t t[10]; ||  jsmn_init(&p);|| ||  fresult=f_open (&Authfile,"/Auth.txt",FA_READ|FA_OPEN_ALWAYS);|| fpointer=0;||  do{||    fresult=f_read (&Authfile,string,150,&temp);||     if(temp>1)||     {||       var = jsmn_parse(&p, string, strlen(string), t, sizeof(t) / sizeof(t[0]));||      if (var < 0) {traceLog("Failed to parse");}||      else{      // if parsed successfully||            if (jsoneq(string, &t[2], idTag) == 0)||            for (char i = 3; i < var; i++) ||             if (jsoneq(string, &t[i], "status") == 0)||                if (jsoneq(string, &t[i+1], "Accepted") == 0)       ||                {f_close(&Authfile); return 1;}  ||          }||       fpointer+=150;||      }||  }while(f_eof(&Authfile)==0);||  f_close(&Authfile);||  return 0;||}|||||void UART4_IRQHandler(void)||{||  uint32_t temp=UART4->SR;||	//Read the data||	char data=UART4->DR;||        if(data=='&')||         wifi_status=WIFI_CONNECTED;||        else if(data=='$')||          wifi_status=WIFI_DISCONNECTED;||        else if(data=='*')||          server_status=CONNECTED_TO_SERVER;||        else if(data=='@')||          server_status=DISCONNECTED_FROM_SERVER;|||        //Now add it to q||	else {||   ||              if(xQueueSendToBackFromISR(usart_q[Q_4], &data, NULL)==errQUEUE_FULL)||              {/*traceLog the error here.*/}||            }|||}||||//Core Profile||char AllowOfflineTxForUnknownId=1;||char AuthorizationCacheEnabled=0;||char AuthorizeRemoteTxRequests;||int BlinkRepeat;||int ClockAlignedDataInterval;||int ConnectionTimeOut;||//ConnectorPhaseRotation||const int ConnectorPhaseRotationMaxLength;||const int GetConfigurationMaxKeys=10;||int HeartbeatInterval;||int LightIntensity;||char LocalAuthorizeOffline=1;||char LocalPreAuthorize;||int MaxEnergyOnInvalidId;||//MeterValuesAlignedData||const int MeterValuesAlignedDataMaxLength;||//MeterValuesSampledData||const int MeterValuesSampledDataMaxLength;||int MeterValueSampleInterval;||int MinimumStatusDuration;||const int NumberOfConnectors;||int ResetRetries;||char StopTransactionOnEVSideDisconnect;||char StopTransactionOnInvalidId;||//StopTxnAlignedData||const int StopTxnAlignedDataMaxLength;||//StopTxnSampledData||const int StopTxnSampledDataMaxLength;||//SupportedFeatureProfiles||const int SupportedFeatureProfilesMaxLength;||int TransactionMessageAttempts;||int TransactionMessageRetryInterval;||char UnlockConnectorOnEVSideDisconnect;||int WebSocketPingInterval;||//Local Auth List Management Profile||char LocalAuthListEnabled;||const int LocalAuthListMaxLength=5;||const int SendLocalListMaxLength=5;||//Reservation Profile||const char ReserveConnectorZeroSupported=0;||// Smart Charging Profile||const int ChargeProfileMaxStackLevel=2;||//ChargingScheduleAllowedChargingRateUnit||const int ChargingScheduleMaxPeriods=1;||const char ConnectorSwitch3to1PhaseSupported=0;||const int MaxChargingProfilesInstalled=1;||||||char timestamp[22];||ChargePoint_t                   ChargePoint;||StartTransactionResp_t          start_transaction_resp;||StopTransactionResp_t           stop_transaction_resp;||StatusNotification_t            notfn_param;||BootNotificationResp_t          boot_resp;||Heartbeat_resp_t                hb_resp;||DataTransfer_t                  data_transfer_param;||DataTransferResp_t              data_transfer_resp;||AuthorizeResp_t                 authorize_resp;||MeterValues_t                   meter_param;||DiagnosticsStatus_t             DiagnosticsStatus;||FirmwareStatusNotification_t    FirmwareStatusNotification;||ChargingProfile_t               ChargingProfile;||int                             listVersion;||unsigned int                    LocalListMaxLength=1;||Diagnostics_t*                  Diagnostics=NULL;||||Connector_t Connector[NO_OF_CONNECTOR];||volatile uint8_t wifi_status=WIFI_DISCONNECTED;||volatile uint8_t server_status=DISCONNECTED_FROM_SERVER;|||/*************************************************************************/||//                      Event Groups||/*************************************************************************/||EventGroupHandle_t EventHandle;||EventBits_t EventBitsValue;||/*************************************************************************/||/*************************************************************************/||||/*************************************************************************/||//                      TaskHandle||/*************************************************************************/||TaskHandle_t OCPP_task_handle=NULL;||TaskHandle_t OCPP_MSG_Handle=NULL;||/*************************************************************************/||/*************************************************************************/||||||uint8_t StartCharging(uint8_t connectorId)||{||  RTC_TimeTypeDef RTC_TimeStruct;||  xEventGroupClearBits(EventHandle,CHARGING_STOPPED|TRANSACTION_REJECTED);||  Connector[connectorId-1].ConnectorStatus=Connector_Preparing;||  send_StatusNotification(connectorId,&notfn_param);|||  if(PrepareChargingCallback(connectorId))||    send_StartTransaction(connectorId, &start_transaction_resp);||  else {traceLog("preparing Failed"); return 0;}|||  if(start_transaction_resp.TransactionStatus==Transaction_Accepted)||  {||    if(StartChargingCallback(connectorId))||    {||      xQueuePeek(SocketQueue[connectorId-1],&Socket,0);||      xQueuePeek(MeterQueue[connectorId-1],&Meter,0);||      xEventGroupSetBits(EventHandle,CHARGING_STARTED);||      Connector[connectorId-1].ConnectorStatus=Connector_Charging;||      Socket.ChargingStatus=CHARGING_HO_RAHI_HAI;||      Socket.OnStartEnergy=Meter.MeterData.R_PhaseActiveEnergy;||       RTC_GetTime( RTC_Format_BIN, &RTC_TimeStruct);||       Socket.StartTime =RTC_TimeStruct.RTC_Hours*60+RTC_TimeStruct.RTC_Minutes;||       xQueueOverwrite(SocketQueue[connectorId-1],&Socket);||      send_StatusNotification(connectorId,&notfn_param);||      send_MeterValues(connectorId,"Transaction.Begin");||      ||      if(xTimerStart(MeterValuesPeriodic_Handle, pdMS_TO_TICKS(5000))==pdFAIL){traceLog("E7");}||    }||    else{traceLog("unable to charge"); return 0;}||   }||    else {||      vPortFree(Connector[connectorId-1].TransactionDetail);         // free the space||      Connector[connectorId-1].TransactionDetail=NULL;||      Connector[connectorId-1].ConnectorStatus=Connector_Available;||      xEventGroupSetBits(EventHandle,TRANSACTION_REJECTED);||      traceLog("txn nt accepted"); return 0;}||    return 1;||}|||uint8_t StopCharging(uint8_t connectorId,char *reason, char *idTag)||{||  xQueuePeek(SocketQueue[connectorId-1],&Socket,0);||  xEventGroupClearBits(EventHandle,CHARGING_STARTED);  ||  Connector[connectorId-1].ConnectorStatus=Connector_Finishing;||  send_StatusNotification(connectorId,&notfn_param);||  MeterValuesPeriodicFlag=0;||  send_MeterValues(connectorId,"Transaction.End");||  StopChargingCallback(connectorId);            // stop charging||  Socket.ChargingStatus=CHARGING_BAND_HO_GAYI_HAI;||  send_StopTransaction(connectorId,idTag,reason,&stop_transaction_resp);||  xEventGroupSetBits(EventHandle,CHARGING_STOPPED);||  Connector[connectorId-1].ConnectorStatus=Connector_Available;||  xQueueOverwrite(SocketQueue[connectorId-1],&Socket);||  return 1;||}||void InitSocket()||{||  for(char i=0;i<3;i++)||  {||    xQueuePeek(SocketQueue[i],&Socket,0);||    Socket.SocketNo=i+1;||    Socket.ChargingStatus=READY_FOR_CHARGING;||    xQueueOverwrite(SocketQueue[i],&Socket);||  }||  ||}||void InitOCPP()||{||  InitSocket();||  MeterValueSampleInterval=120;||  AuthorizeRemoteTxRequests=1;||  EventHandle=xEventGroupCreate();||  RTC_Initialize();||  SPI_Init(SD_SPI);||  //Init_Common();||  OCPP_Resp_semaphore=xSemaphoreCreateBinary();||  strcpy(ChargePoint.chargeBoxSerialNumber,"123");||  strcpy(ChargePoint.chargePointModel,"EVDC4K");||  strcpy(ChargePoint.chargePointSerialNumber,"12345");||  strcpy(ChargePoint.chargePointVendor,"EVIT");||  strcpy(ChargePoint.iccid,"56");|| // strcpy(ChargePoint.idTag,"678");||  strcpy(ChargePoint.imsi,"78");||  strcpy(ChargePoint.meterSerialNumber,"587");||  strcpy(ChargePoint.meterType,"1Ph");||  strcpy(ChargePoint.vendorId,"2");||  strcpy(ChargePoint.ChargePointError,"NoError");||  boot_resp.Boot_Status=Boot_Rejected;||  for(char k=0; k<NO_OF_CONNECTOR; k++)||  {||    Connector[k].ConnectorStatus=Connector_Available;||    Connector[k].Reservation=NULL;||    Connector[k].TransactionDetail=NULL;||  }||}|||void Clear(int connectorId)||{||  xQueuePeek(MeterQueue[connectorId-1],&Meter,0);||  xQueuePeek(SocketQueue[connectorId-1],&Socket,0);||  Socket.ChargingStatus=READY_FOR_CHARGING;||  Socket.ChargingTime=0;||  Socket.EnergyConsumed=0;||  strcpy(Socket.PreviousError,"");||  Meter.UnderCurrentFlag=0;||  ||  xQueueOverwrite(SocketQueue[connectorId-1],&Socket);||  xQueueOverwrite(MeterQueue[connectorId-1],&Meter);||}|||